<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/">
	<channel>
		<title>Thomas T Burgess&apos;s Blog | Numbers, numbers - everywhere!</title>
		<generator>(c) Chulapa Jekyll Theme RSS generator</generator>
		<link>https://thomasburgess.github.io/</link>
		<description>Personal blog of particle physicist and data scientist Thomas T Burgess.  Here I write about math, geometric art, python coding, statistics, data science,  machine learning and other things I do.
</description>
		<language>en-US</language>
		<copyright>(c) 2025, Thomas T Burgess</copyright>	
		<pubDate>Fri, 03 Jan 2025 19:53:22 +0100</pubDate>
		<lastBuildDate>Fri, 03 Jan 2025 19:53:22 +0100</lastBuildDate>
		<category>blog</category>
		<ttl>60</ttl>
		<atom:link href="https://thomasburgess.github.io/rss.xml" rel="self" type="application/rss+xml" />
		<image>
			<title>Thomas T Burgess&apos;s Blog | Numbers, numbers - everywhere!</title>
			<url>https://github.com/thomasburgess.png</url>
			<link>https://thomasburgess.github.io/</link>
			<description>Personal blog of particle physicist and data scientist Thomas T Burgess.  Here I write about math, geometric art, python coding, statistics, data science,  machine learning and other things I do.
</description>
		</image><item>
			<title>Passwords with Polars</title>
			<description>
				<![CDATA[	
 				<h3><p>Wrangling csv password manager exports</p>
</h3>
    		<p>10 min.</p>
				<div><p><em>Header image credit</em><sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></p>

<h2 id="introduction">Introduction</h2>

<p>Over time, I have tried several approaches to password management:
<a href="https://www.LastPass.com/">LastPass</a>, <a href="https://www.mozilla.org/en-US/firefox/">Firefox</a>, 
and Safari (now Apple’s Passwords app). Not all passwords have been migrated when 
switching solution. In this post, I’ll consolidate <code class="highlighter-rouge">.csv</code> exports from different 
password managers, and analyze the resulting dataset. This is somewhat complicated as
each manager has its own format and content. Furthermore, there is overlap between the
different exports.</p>

<p>I’ll tackle this challenge with <a href="https://docs.pola.rs/">Polars</a> - a fast DataFrame 
library for manipulating structured data written in <a href="https://www.rust-lang.org/">Rust</a>, 
with a Python interface. Being well-versed in <a href="https://pandas.pydata.org">Pandas</a>, I 
took this project as an opportunity to explore Polars and understand its unique 
strengths and abilities.</p>

<p><em>Note: Be carefull with your passwords, and don’t read any of this as security advice.</em></p>

<h2 id="python-environment">Python environment</h2>

<p>I’m using the python 3.12 standard library and Polars 1.12.0 (the latest 
version as of 2024-11-04).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Self</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="n">pl</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_exponential</span><span class="p">,</span> <span class="n">retry_if_exception</span>
</code></pre></div></div>

<h2 id="fun-with-file-formats">Fun with File Formats</h2>

<p>Each password manager exports data in its own format. I printed the column headers from 
the first line of each file and found the following:</p>

<figure>
<table>
  <thead>
    <tr>
      <th>Source</th>
      <th>Columns</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Safari</td>
      <td><code class="highlighter-rouge">Title</code>, <code class="highlighter-rouge">Url</code>, <code class="highlighter-rouge">Username</code>, <code class="highlighter-rouge">Password</code>, <code class="highlighter-rouge">OTPAuth</code></td>
    </tr>
    <tr>
      <td>Passwords</td>
      <td><code class="highlighter-rouge">Title</code>, <code class="highlighter-rouge">URL</code>, <code class="highlighter-rouge">Username</code>, <code class="highlighter-rouge">Password</code>, <code class="highlighter-rouge">Notes</code>, <code class="highlighter-rouge">OTPAuth</code></td>
    </tr>
    <tr>
      <td>LastPass</td>
      <td><code class="highlighter-rouge">url</code>, <code class="highlighter-rouge">username</code>, <code class="highlighter-rouge">password</code>, <code class="highlighter-rouge">totp</code>, <del><code class="highlighter-rouge">extra</code></del>, <code class="highlighter-rouge">name</code>, <del><code class="highlighter-rouge">grouping</code></del>, <del><code class="highlighter-rouge">fav</code></del></td>
    </tr>
    <tr>
      <td>Firefox</td>
      <td><code class="highlighter-rouge">url</code>, <code class="highlighter-rouge">username</code>, <code class="highlighter-rouge">password</code>, <del><code class="highlighter-rouge">httpRealm</code></del>, <del><code class="highlighter-rouge">formActionOrigin</code></del>, <del><code class="highlighter-rouge">guid</code></del>, <del><code class="highlighter-rouge">timeCreated</code></del>, <del><code class="highlighter-rouge">timeLastUsed</code></del>, <code class="highlighter-rouge">timePasswordChanged</code></td>
    </tr>
  </tbody>
</table>

  <figcaption><strong>Table 1</strong>: Initial column headers from different password managers</figcaption>
</figure>

<p>They have different columns, with different names, and Firefox has two header rows. 
The second header row must be skipped, not to appear as junk data in the imported <code class="highlighter-rouge">.csv</code>. 
I put all Columns I won’t bother with in strike-through.</p>

<p>I’m not using LastPass or Firefox at the moment, and Safari’s passwords are superseded 
by Apple Passwords, so I will try to make all formats like that. So, I came up with the 
following mapping to a unified Output column set:</p>

<figure>
<table>
  <thead>
    <tr>
      <th>Output</th>
      <th>Safari</th>
      <th>LastPass</th>
      <th>Firefox</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">Title</code></td>
      <td><code class="highlighter-rouge">Title</code></td>
      <td><code class="highlighter-rouge">name</code></td>
      <td><code class="highlighter-rouge">url</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">URL</code></td>
      <td><code class="highlighter-rouge">Url</code></td>
      <td><code class="highlighter-rouge">url</code></td>
      <td><code class="highlighter-rouge">url</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">Username</code></td>
      <td><code class="highlighter-rouge">Username</code></td>
      <td><code class="highlighter-rouge">username</code></td>
      <td><code class="highlighter-rouge">username</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">Password</code></td>
      <td><code class="highlighter-rouge">Password</code></td>
      <td><code class="highlighter-rouge">password</code></td>
      <td><code class="highlighter-rouge">password</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">Notes</code></td>
      <td>””</td>
      <td>””</td>
      <td>””</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">OTPAuth</code></td>
      <td><code class="highlighter-rouge">OTPAuth</code></td>
      <td><code class="highlighter-rouge">totp</code></td>
      <td>””</td>
    </tr>
  </tbody>
</table>

  <figcaption><strong>Table 2</strong>: Mapping columns to a unified output format</figcaption>
</figure>

<p>To represent formats, I made a <code class="highlighter-rouge">dataclass</code> <code class="highlighter-rouge">Source</code> with the name of the columns,
and a mapping to the output column names. Then, all <code class="highlighter-rouge">Source</code>s were put in an <code class="highlighter-rouge">Enum</code> to
keep things tidy. I added  additional properties to support additional differences in 
the data sets: <code class="highlighter-rouge">header_rows</code> to handle longer headers, and <code class="highlighter-rouge">modification_date</code> if there 
is a column with that in the source data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Source</span><span class="p">:</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">otp_auth</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">header_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">modification_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">).</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"Title"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">"URL"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
            <span class="s">"Username"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">"Password"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">password</span><span class="p">,</span>
            <span class="s">"Notes"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">notes</span><span class="p">,</span>
            <span class="s">"OTPAuth"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">otp_auth</span><span class="p">,</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">Sources</span><span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">APPLE</span> <span class="o">=</span> <span class="s">"Title"</span><span class="p">,</span> <span class="s">"URL"</span><span class="p">,</span> <span class="s">"Username"</span><span class="p">,</span> <span class="s">"Password"</span><span class="p">,</span> <span class="s">"Notes"</span><span class="p">,</span> <span class="s">"OTPAuth"</span>
    <span class="n">FIREFOX</span> <span class="o">=</span> <span class="s">"url"</span><span class="p">,</span> <span class="s">"url"</span><span class="p">,</span> <span class="s">"username"</span><span class="p">,</span> <span class="s">"password"</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"timePasswordChanged"</span>
    <span class="n">LASTPASS</span> <span class="o">=</span> <span class="s">"name"</span><span class="p">,</span> <span class="s">"url"</span><span class="p">,</span> <span class="s">"username"</span><span class="p">,</span> <span class="s">"password"</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"totp"</span>
    <span class="n">SAFARI</span> <span class="o">=</span> <span class="s">"Title"</span><span class="p">,</span> <span class="s">"Url"</span><span class="p">,</span> <span class="s">"Username"</span><span class="p">,</span> <span class="s">"Password"</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"OTPAuth"</span>
</code></pre></div></div>

<p>This approach keeps things neat and tidy, and I can rely on type hints and be less
likely to run into issues with misspelled keys.</p>

<h2 id="lazy-loading">Lazy Loading</h2>

<p>Polars’ <code class="highlighter-rouge">scan_csv</code> function allows lazy loading of data (as <code class="highlighter-rouge">LazyFrame</code>), which 
deferrs computations until explicitly collected. This is great for handling large inputs 
without consuming excessive memory. While my password files are too small for this to
make any noticeable differences, I wanted to take this opportunity to learn how to use 
this Polars feature.</p>

<p>In <code class="highlighter-rouge">scan_csvs</code>, I’m concatenating LazyFrames representing data from a specific source
type, such as a particular password manager. Additionally, I’m adding metadata columns
for the input file:</p>

<ul>
  <li><code class="highlighter-rouge">path</code>: the input file path - to make it easier to track down input file problems.</li>
  <li><code class="highlighter-rouge">modification_date</code>: last modification timestamp - to select the most recent version 
of a duplicate entry.</li>
  <li><code class="highlighter-rouge">source</code>: the password manager used - to better undestand coversion issues.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scan_csvs</span><span class="p">(</span><span class="n">paths</span> <span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pl</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pl</span><span class="p">.</span><span class="n">scan_csv</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">has_header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">skip_rows_after_header</span><span class="o">=</span><span class="n">source</span><span class="p">.</span><span class="n">header_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">).</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="p">.</span><span class="n">lit</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"path"</span><span class="p">),</span>
                <span class="n">pl</span><span class="p">.</span><span class="n">lit</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">stat</span><span class="p">().</span><span class="n">st_mtime</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"modification_date"</span><span class="p">),</span>
                <span class="n">pl</span><span class="p">.</span><span class="n">lit</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">lower</span><span class="p">()).</span><span class="n">alias</span><span class="p">(</span><span class="s">"source"</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>With this I can Polars up to process my inputs, like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lastpass_df</span> <span class="o">=</span> <span class="n">scan_csvs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s">'store/LastPass'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span> <span class="n">Sources</span><span class="p">.</span><span class="n">LASTPASS</span><span class="p">)</span>
<span class="n">firefox_df</span> <span class="o">=</span> <span class="n">scan_csvs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s">'store/Firefox'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span> <span class="n">Sources</span><span class="p">.</span><span class="n">FIREFOX</span><span class="p">)</span>
</code></pre></div></div>

<p>To print a data frame to markdown for a blog like this one, you can use</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pl</span><span class="p">.</span><span class="n">Config</span><span class="p">(</span>
    <span class="n">tbl_cols</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">fmt_str_lengths</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
    <span class="n">set_tbl_width_chars</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
    <span class="n">set_tbl_formatting</span><span class="o">=</span><span class="s">'ASCII_MARKDOWN'</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cfg</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">lastpass_df</span><span class="p">.</span><span class="n">collect</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">firefox_df</span><span class="p">.</span><span class="n">collect</span><span class="p">())</span>
</code></pre></div></div>
<p>Note, that to see a table I need to <code class="highlighter-rouge">collect()</code> the data first. The formatting is quite
flexible, but tends to shorten most entires. For the markdown to work on my blog, 
I had to remove the header separator and the type line. Here’s the  output for some 
dummy inputs:</p>

<figure>
<table>
  <thead>
    <tr>
      <th>url</th>
      <th>username</th>
      <th>password</th>
      <th>totp</th>
      <th>extra</th>
      <th>name</th>
      <th>grouping</th>
      <th>fav</th>
      <th>path</th>
      <th>modifica…</th>
      <th>source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>https://…</td>
      <td>dummy@dm…</td>
      <td>secret</td>
      <td> </td>
      <td> </td>
      <td>dummy.co…</td>
      <td> </td>
      <td>0</td>
      <td>lastpass…</td>
      <td>16068464…</td>
      <td>lastpass</td>
    </tr>
    <tr>
      <td>https://…</td>
      <td>dummy@dm…</td>
      <td>password</td>
      <td> </td>
      <td> </td>
      <td>dummy.or…</td>
      <td> </td>
      <td>0</td>
      <td>lastpass…</td>
      <td>16699184…</td>
      <td>lastpass</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 3</strong>: Example output from LastPass data</figcaption>
</figure>

<figure>
<table>
  <thead>
    <tr>
      <th>url</th>
      <th>username</th>
      <th>password</th>
      <th>httpReal…</th>
      <th>formActi…</th>
      <th>guid</th>
      <th>timeCrea…</th>
      <th>timeLast…</th>
      <th>timePass…</th>
      <th>path</th>
      <th>modifica…</th>
      <th>source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>https://…</td>
      <td>benutzer</td>
      <td>gehemini…</td>
      <td> </td>
      <td>https://…</td>
      <td>b4f76bb8…</td>
      <td>17014544…</td>
      <td>17040464…</td>
      <td>17014544…</td>
      <td>firefox_…</td>
      <td>2023-12-…</td>
      <td>firefox</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 4</strong>: Example output from Firefox data</figcaption>
</figure>

<p>All the expected columns are read in!</p>

<h2 id="transformation">Transformation</h2>

<p>Next, I need to apply format-specific mapping to the data to make data from the 
different sources compatible. This will rename columns according to the 
<code class="highlighter-rouge">Source.mapping()</code>. For missing columns (which are represented as <code class="highlighter-rouge">None</code> in the 
<code class="highlighter-rouge">Source</code> field) an empty string column will be added to ensure all expected columns 
will exist in the output.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_column_mapping</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">source_col</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source_col</span>
            <span class="k">else</span> <span class="n">pl</span><span class="p">.</span><span class="n">lit</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">source_col</span> <span class="ow">in</span> <span class="n">source</span><span class="p">.</span><span class="n">mapping</span><span class="p">().</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>The modification dates are useful to resolve duplicate entries. All inputs files have 
the <code class="highlighter-rouge">modification_date</code> column, but for Firefox data also hase <code class="highlighter-rouge">timePasswordChanged</code> 
per entry. File modification dates are represented as floating-point seconds since the 
Unix epoch, whereas <code class="highlighter-rouge">timePasswordChanged</code> is an integer in milliseconds. To maintain 
consistency, I scale the seconds and cast all values to integers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fix_modification_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">modification_date</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"modification_date"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span><span class="p">.</span><span class="n">modification_date</span>
            <span class="k">else</span> <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"modification_date"</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">).</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">Int64</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>With this, all data have a common set of columns, and a <code class="highlighter-rouge">modification_date</code> usable for 
comparisons, and is ready to be concatenated:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">combine_dataframes</span><span class="p">(</span><span class="n">source_paths</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pl</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">scan_csvs</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_column_mapping</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fix_modification_date</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="p">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s">"Title"</span><span class="p">,</span>
                    <span class="s">"URL"</span><span class="p">,</span>
                    <span class="s">"Username"</span><span class="p">,</span>
                    <span class="s">"Password"</span><span class="p">,</span>
                    <span class="s">"Notes"</span><span class="p">,</span>
                    <span class="s">"OTPAuth"</span><span class="p">,</span>
                    <span class="s">"modification_date"</span><span class="p">,</span>
                    <span class="s">"source"</span><span class="p">,</span>
                    <span class="s">"path"</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">source_paths</span><span class="p">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Now I can combine several data sets:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined_df</span> <span class="o">=</span> <span class="n">combine_dataframes</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">Sources</span><span class="p">.</span><span class="n">FIREFOX</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s">"store/Firefox"</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span>
        <span class="n">Sources</span><span class="p">.</span><span class="n">LASTPASS</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s">"store/Lastpass"</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<figure>
<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>URL</th>
      <th>Username</th>
      <th>Password</th>
      <th>Notes</th>
      <th>OTPAuth</th>
      <th>modification_date</th>
      <th>source</th>
      <th>path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dummy.com</td>
      <td>https://www.dummy.com/</td>
      <td>dummy@dmail.com</td>
      <td>secret</td>
      <td> </td>
      <td> </td>
      <td>1606846453000</td>
      <td>lastpass</td>
      <td>lastpass_2020.csv</td>
    </tr>
    <tr>
      <td>dummy.org</td>
      <td>https://dummy.org</td>
      <td>dummy@dmail.com</td>
      <td>password</td>
      <td> </td>
      <td> </td>
      <td>1669918453000</td>
      <td>lastpass</td>
      <td>lastpass_2021.csv</td>
    </tr>
    <tr>
      <td>https://dummy.at</td>
      <td>https://dummy.at</td>
      <td>benutzer</td>
      <td>geheminis</td>
      <td> </td>
      <td> </td>
      <td>1701454453123</td>
      <td>firefox</td>
      <td>firefox_2023.csv</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 5</strong>: Combined dataset after mapping and modification date adjustment</figcaption>
</figure>

<p>All the inputs have been combined to a single dataset with unified modification dates.</p>

<h2 id="fun-with-filters">Fun with Filters</h2>

<p>With the unified dataset, it is time to filter the data. To get rid of duplicates, I 
group by <code class="highlighter-rouge">Title</code>, <code class="highlighter-rouge">URL</code>, and <code class="highlighter-rouge">Username</code> and select only the latest entry based on 
<code class="highlighter-rouge">modification_date</code>. This approach has some potential risks, as actual modification 
dates can sometimes be earlier than file modification dates, but it works well with the 
data I have.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_latest</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
        <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"modification_date"</span><span class="p">)</span>
        <span class="o">==</span> <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"modification_date"</span><span class="p">).</span><span class="nb">max</span><span class="p">().</span><span class="n">over</span><span class="p">([</span><span class="s">"Title"</span><span class="p">,</span> <span class="s">"URL"</span><span class="p">,</span> <span class="s">"Username"</span><span class="p">])</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>Next, I want to exclude certain rows based on specific criteria, using 
<a href="https://en.wikipedia.org/wiki/Regular_expression">regular expressions</a>s:
on the different column values. I’m using a dictionary with a list of rules, like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">excludes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Title"</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s">"Facebook"</span><span class="p">],</span>
    <span class="s">"URL"</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s">"dummy\.org"</span><span class="p">,</span> <span class="s">"dummy\.net"</span><span class="p">]</span>
    <span class="s">"Username"</span><span class="p">:</span> <span class="p">[</span><span class="s">"benutzer"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To apply them, I concatenate the rules for each column, and reduce all filters to a 
single expression that can be used with <code class="highlighter-rouge">df.filter</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">exclude_entries</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">excludes</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">excludes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">~</span><span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">"|"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">exprs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">exprs</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exprs</span>
    <span class="p">]</span>
    <span class="n">combined_filter</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">filters</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">pl</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">acc</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">acc</span> <span class="o">&amp;</span> <span class="n">f</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">combined_filter</span><span class="p">)</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="n">df</span>
</code></pre></div></div>

<p>Now, I can chain it all together</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">combine_dataframes</span><span class="p">({</span>
        <span class="n">Sources</span><span class="p">.</span><span class="n">APPLE</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s">'store/Apple'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span>
        <span class="n">Sources</span><span class="p">.</span><span class="n">SAFARI</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s">'store/Safari'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span>
        <span class="n">Sources</span><span class="p">.</span><span class="n">FIREFOX</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s">'store/Firefox'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span>
        <span class="n">Sources</span><span class="p">.</span><span class="n">LASTPASS</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="s">'store/Lastpass'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"*.csv"</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_latest</span><span class="p">)</span>
    <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">exclude_entries</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="n">excludes</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>To see the Polars’ query plan, you can print <code class="highlighter-rouge">result</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<figure>
<p><img src="/assets/images/2024/11/04/polars_lazy_graph.png" alt="Polars query plan" id="figure-1" /></p>
  <figcaption><strong>Figure 1</strong>: Polars query plan. It’s huge.</figcaption>
</figure>

<p>Now the data is as clean as it is going to get.</p>

<h2 id="make-it-useful">Make it useful!</h2>

<p>An obvious use of the combined dataset is be to use 
<a href="https://docs.pola.rs/api/python/stable/reference/expressions/api/polars.Expr.value_counts.html">value_counts</a>
to see how often values have been used:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined_df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"URL"</span><span class="p">).</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"n"</span><span class="p">)).</span><span class="n">unnest</span><span class="p">(</span><span class="s">"URL"</span><span class="p">)</span>
<span class="n">combined_df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Password"</span><span class="p">).</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"n"</span><span class="p">)).</span><span class="n">unnest</span><span class="p">(</span><span class="s">"Password"</span><span class="p">)</span>
<span class="n">combined_df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Username"</span><span class="p">).</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"n"</span><span class="p">)).</span><span class="n">unnest</span><span class="p">(</span><span class="s">"Username"</span><span class="p">)</span>
</code></pre></div></div>
<p>With my dummy data I get:</p>

<figure>
<table>
  <thead>
    <tr>
      <th>URL</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>https://www.dummy.com/</td>
      <td>1</td>
    </tr>
    <tr>
      <td>https://dummy.org</td>
      <td>1</td>
    </tr>
    <tr>
      <td>https://dummy.at</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 6</strong>: URL usage counts</figcaption>
</figure>

<figure>
<table>
  <thead>
    <tr>
      <th>Password</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>secret</td>
      <td>1</td>
    </tr>
    <tr>
      <td>password</td>
      <td>1</td>
    </tr>
    <tr>
      <td>geheminis</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 7</strong>: Password usage counts</figcaption>
</figure>

<figure>
<table>
  <thead>
    <tr>
      <th>Username</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dummy@dmail.com</td>
      <td>2</td>
    </tr>
    <tr>
      <td>benutzer</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 8</strong>: Username usage counts</figcaption>
</figure>

<p>With this I can figure out URL and emails that I may want to put in my exclude list, or
identify reused passwords. I can also sort the data by time stamp to catch the oldest 
entries:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined_df</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="s">"modification_date"</span><span class="p">)</span>
</code></pre></div></div>
<p>and course save the combined output</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined</span><span class="p">.</span><span class="n">write_csv</span><span class="p">(</span><span class="s">"combined.csv"</span><span class="p">)</span>
</code></pre></div></div>
<p>And this file I can import into Apple passwords again, to have everything in the same
place. But before I do that, I should check if the passwords have been compromised.</p>

<h2 id="have-i-been-pwned">Have I Been Pwned?</h2>

<p><a href="https://haveibeenpwned.com/API/v3">Have I Been Pwned API</a> (HIBP) offers a free API to 
query wether passwords have been exposed in a data breach. The API uses a pretty nice 
way to ensure <a href="https://en.wikipedia.org/wiki/K-anonymity">K-anonymity</a> of request 
password hashes. With this approach, you send only the first 5 characters of a passwords 
sha-1 hash. The result contains many pwned hashes, and to check for a breach you only
match the last 5 characters of your hash with the response. As many different passwords
share the partial hash, request traffice can’t be pinned down to any specific person.</p>

<p>Not to abuse the free API, i use <a href="https://tenacity.readthedocs.io/en/latest/">tenacity</a>
to ensure my requests handle rate limiting. Careless querying may cause the API to ban 
your IP from making queries. Here is how to check one password:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests.status_codes</span> <span class="kn">import</span> <span class="n">codes</span>

<span class="k">def</span> <span class="nf">should_retry</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">HTTPError</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">codes</span><span class="p">.</span><span class="n">too_many_requests</span>
    <span class="p">)</span>

<span class="o">@</span><span class="n">retry</span><span class="p">(</span>
    <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception</span><span class="p">(</span><span class="n">should_retry</span><span class="p">),</span>
    <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">pwn_check</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="n">sha1_password</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)).</span><span class="n">hexdigest</span><span class="p">().</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">sha1_password</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">sha1_password</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"https://api.pwnedpasswords.com/range/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">splitlines</span><span class="p">())</span>
</code></pre></div></div>

<p>Next, I want to do this for all the unique passwords in my dataframe with 
<a href="https://docs.pola.rs/api/python/stable/reference/expressions/api/polars.Expr.map_elements.html">map_elements</a>.
Finally, I return the entries where <code class="highlighter-rouge">pwn_check</code> is <code class="highlighter-rouge">True</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">pwn_check_unique_passwords</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">unique_passwords</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Password"</span><span class="p">).</span><span class="n">is_not_null</span><span class="p">()).</span><span class="n">select</span><span class="p">(</span><span class="s">"Password"</span><span class="p">).</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">compromised</span> <span class="o">=</span> <span class="n">unique_passwords</span><span class="p">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Password"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">map_elements</span><span class="p">(</span><span class="n">pwn_check</span><span class="p">,</span> <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="n">Boolean</span><span class="p">)</span>
        <span class="p">.</span><span class="n">alias</span><span class="p">(</span><span class="s">"haveibeenpwnd"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">compromised</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">"Password"</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">"left"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"haveibeenpwnd"</span><span class="p">).</span><span class="n">fill_null</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nb">all</span><span class="p">().</span><span class="n">exclude</span><span class="p">(</span><span class="s">"Password"</span><span class="p">))</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>I removed passwords here as I don’t need them to check the breached accounts. The 
resulting dataframe cointains accounts that aren’t neccissarily compromised, but that at
some point that password has been in a breach. The search found a few old bad passwords, 
that I had to reset / remove.</p>

<p>Here’s an example of the output for my dummy data:</p>

<figure>
<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>URL</th>
      <th>Username</th>
      <th>Notes</th>
      <th>OTPAuth</th>
      <th>modification_date</th>
      <th>source</th>
      <th>path</th>
      <th>haveibeenpwnd</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dummy.com</td>
      <td>https://www.dummy.com/</td>
      <td>dummy@dmail.com</td>
      <td> </td>
      <td> </td>
      <td>1606846453000</td>
      <td>lastpass</td>
      <td>lastpass_2020.csv</td>
      <td>True</td>
    </tr>
    <tr>
      <td>dummy.org</td>
      <td>https://dummy.org</td>
      <td>dummy@dmail.com</td>
      <td> </td>
      <td> </td>
      <td>1669918453000</td>
      <td>lastpass</td>
      <td>lastpass_2021.csv</td>
      <td>False</td>
    </tr>
    <tr>
      <td>https://dummy.at</td>
      <td>https://dummy.at</td>
      <td>benutzer</td>
      <td> </td>
      <td> </td>
      <td>1701454453123</td>
      <td>firefox</td>
      <td>firefox_2023.csv</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
  <figcaption><strong>Table 9</strong>: Accounts with potentially compromised passwords</figcaption>
</figure>

<h2 id="conclusion">Conclusion</h2>

<p>Polars is fast and powerful, and it encourages the style of coding I prefer when using 
Pandas. I found some tasks with Polars slightly more challenging, but that could be that
I’m still learning. Still, Polars’ lazy loading and transformation capabilities allowed
me to efficiently standardize, clean, and merge password data from multiple sources.</p>

<p>It was useful to get a list of used accounts, I could immediately delete a bunch of old
data. I enjoyed figuring out the HIBP check, tenacity makes it very clean. For the most
used passwords I can manually check on the HIBP website (the API for accounts is not 
free). I picked up some new techniques for filtering and selecting data within 
Polars DataFrames. For my dataset, I didn’t really need the additional performance over 
Pandas, but it is nice to have another tool available when it is needed. I like how 
Polars has improved on Pandas, the de facto standard library for data frames in data 
science. I will certainly keep exploring Polars in further projects.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Crop from a photo by <a href="https://unsplash.com/@hansjurgen007?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Hans-Jurgen Mager</a> on <a href="https://unsplash.com/photos/polar-bear-on-snow-covered-ground-during-daytime-ffE6g1p5mjc?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Unsplash</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2024/11/04/Passwords-with-Polars.html</link>
			<category>posts</category>
		    <category>coding</category><category>csv</category><category>polars</category><category>python</category><media:title type="html"><![CDATA[Passwords with Polars ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2024/11/04/hans-jurgen-mager-ffE6g1p5mjc-unsplash.jpg" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2024/11/04/hans-jurgen-mager-ffE6g1p5mjc-unsplash.jpg" /><guid isPermaLink="true">https://thomasburgess.github.io/2024/11/04/Passwords-with-Polars.html</guid>
      <pubDate>Mon, 04 Nov 2024 00:00:00 +0100</pubDate>
		</item><item>
			<title>Say the prime</title>
			<description>
				<![CDATA[	
 				<h3><p>The 52nd Mersenne Prime digits 3772-4190.</p>
</h3>
    		<p>1 min.</p>
				<div><h2 id="introduction">Introduction</h2>

<p>Recently, I blogged about 
<a href="/2024/10/26/mersenne.html">Mersenne prime numbers</a>. 
Today, I saw the announcement of 
<a href="https://saytheprime.com/">Say The Prime</a>. 
Of course I will join the effort!</p>

<p>The goal of <em>Say The Prime</em> is to have people say all the 41 million
digits of the 52nd Mersenne prime number on a YouTube Playlist. At a
rate of 2 primes per second, that is about 8 months of content -
impressive!</p>

<h2 id="my-digits">My digits</h2>

<p>I was assigned the 419 digits 3772 until 4190, so I had 
to record myself saying:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>84899 16752 24758 02289 14833 92952 58929
01292 81228 73739 22338 93368 46330 97159
54800 52022 47750 09676 45100 06799 89178
00230 57054 32094 83383 16326 31135 74888
43585 14039 61361 07647 07273 79607 22563
75908 51215 85373 49142 85574 20593 55708
91326 82291 72426 53213 48127 44084 76552
93152 87312 05963 30714 49699 70499 45342
69086 57434 11006 29158 92427 53991 38571
39321 66753 40499 13526 97149 98523 38187
27620 16319 14172 56912 69335 15740 70997
34236 57222 21157 27736 00389 36533 4278
</code></pre></div></div>

<h2 id="process">Process</h2>

<p>I recorded my voice right into Logic, not remembering to record a 
video. Recording and editing was quite annoying, so I decided to take
the audio and put a vidoe to it. I used 
<a href="https://apps.apple.com/us/app/hedron/id1552617460">Hedron</a> for
a quick animation of a dodecahedron made out of (hidden) dodecahedra and <a href="https://en.wikipedia.org/wiki/Metabidiminished_icosahedron">metabidiminished icosahedra</a>, which while quite unrelated to primes looks pretty nice…</p>

<h2 id="my-video">My video</h2>

<!-- Thanks to alfurka,groupboard -->
<!-- Based on https://github.com/alfurka/jekyll-embed-youtube-lazy-load -->
<div itemscope="" itemprop="VideoObject" itemtype="https://schema.org/VideoObject">
<div data-src="YDxKsGUyzOI" class="ch_ytdefer embed-responsive embed-responsive-16by9 my-2 chulapa-rounded-lg" style="background-image: url(https://img.youtube.com/vi/YDxKsGUyzOI/maxresdefault.jpg); background-position: center; background-size: cover;" itemprop="thumbnailUrl" content="https://img.youtube.com/vi/YDxKsGUyzOI/maxresdefault.jpg"> 
<div class="d-none" itemprop="embedUrl" content="https://www.youtube-nocookie.com/embed/YDxKsGUyzOI"></div>
	<button class="ch_ytdefer_btn" aria-label="Play" style="background-image: url(&quot;data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjEwMCUiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmlld0JveD0iMCAwIDY4IDQ4IiB3aWR0aD0iMTAwJSI+PHBhdGggY2xhc3M9Inl0cC1sYXJnZS1wbGF5LWJ1dHRvbi1iZyIgZD0iTTY2LjUyLDcuNzRjLTAuNzgtMi45My0yLjQ5LTUuNDEtNS40Mi02LjE5QzU1Ljc5LC4xMywzNCwwLDM0LDBTMTIuMjEsLjEzLDYuOSwxLjU1IEMzLjk3LDIuMzMsMi4yNyw0LjgxLDEuNDgsNy43NEMwLjA2LDEzLjA1LDAsMjQsMCwyNHMwLjA2LDEwLjk1LDEuNDgsMTYuMjZjMC43OCwyLjkzLDIuNDksNS40MSw1LjQyLDYuMTkgQzEyLjIxLDQ3Ljg3LDM0LDQ4LDM0LDQ4czIxLjc5LTAuMTMsMjcuMS0xLjU1YzIuOTMtMC43OCw0LjY0LTMuMjYsNS40Mi02LjE5QzY3Ljk0LDM0Ljk1LDY4LDI0LDY4LDI0UzY3Ljk0LDEzLjA1LDY2LjUyLDcuNzR6IiBmaWxsPSIjMjEyMTIxIiBmaWxsLW9wYWNpdHk9IjAuOCI+PC9wYXRoPjxwYXRoIGQ9Ik0gNDUsMjQgMjcsMTQgMjcsMzQiIGZpbGw9IiNmZmYiPjwvcGF0aD48L3N2Zz4=&quot;); position: absolute; border: 0px; background-color: transparent; left: calc(50% - 73px/2); top: calc(50% - 52px/2); width: 73px; height: 52px; pointer-events: none;"></button>
</div>
</div>
<!-- Load script only if needed -->
<script>
if(null==(ch_defer_script=document.getElementById("ch_ytdeferScript"))){var e=document,t=e.createElement("script");t.src="https://cdn.jsdelivr.net/gh/dieghernan/chulapa@master/assets/js/ch_ytdefer/ch_ytdefer.min.js",t.id="ch_ytdeferScript",e.body.appendChild(t)}else console.log("Chulapa YouTube Defer already loaded");
</script>

</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2024/11/02/saytheprime.html</link>
			<category>posts</category>
		    <category>maths</category><category>primes</category><category>youtube</category><media:title type="html"><![CDATA[Say the prime ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2024/11/02/saytheprime.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2024/11/02/saytheprime.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2024/11/02/saytheprime.html</guid>
      <pubDate>Sat, 02 Nov 2024 00:00:00 +0100</pubDate>
		</item><item>
			<title>Blog setup</title>
			<description>
				<![CDATA[	
 				<h3><p>High expectations colliding with harsh reality…</p>
</h3>
    		<p>3 min.</p>
				<div><p><em>Header photo credit</em><sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></p>

<h2 id="introduction">Introduction</h2>

<p>This blog is built with <a href="http://jekyllrb.com/">Jekyll</a> and 
and is hosted for free on <a href="https://github.com/">GitHub</a> with 
<a href="https://pages.github.com/">GitHub pages</a>. The site is generated from markdown sources
automatically on every push to the blog’s
<a href="https://github.com/thomasburgess/thomasburgess.github.io">git repository</a>.</p>

<p>The first version (v1.0 documented here 2021-06-12) of this blog used the 
<a href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt</a> theme. The current version 
(v2.0, 2024-10-30) is using a simpler setip with the 
<a href="https://dieghernan.github.io/chulapa/">Chulapa</a> theme
and <a href="https://bootswatch.com/minty/">https://bootswatch.com/minty/</a> skin.
For some earlier attempt at blogging I used <a href="https://gitlab.com">GitLab</a>, but I with 
this blog I wanted to try <a href="https://pages.github.com/">GitHub pages</a>.</p>

<p>Finding and configuring a suitable theme was more challenging than getting a blog up and 
running. I found the v1.0 TeXt theme too complicated and focusing a lot on things I 
don’t want or need. The v2.0 Chulapa theme was a lot easier to get started with. My main 
requirement for a theme is that it supports code syntax highlighting and math with 
<a href="https://www.mathjax.org/">MathJax maths</a> out of the box.</p>

<h2 id="getting-the-blog-up-and-running">Getting the blog up and running</h2>

<p>I’m using the <a href="https://github.com/benbalter/jekyll-remote-theme">remote_theme</a> to get my 
theme working. When writing a post, or testing modifications. There is a useful help 
repo <a href="https://github.com/dieghernan/chulapa-101">Chulapa-101</a> to quickly get things 
working.</p>

<p>I run Jekyll locally before pushing it to GitHub.
Posts added to <code class="highlighter-rouge">_drafts/</code> will not be published when pushing, 
which is great when writing longer posts.
To serve the site including drafts locally to the default 
<code class="highlighter-rouge">http://127.0.0.1:4000</code>, I run</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle <span class="nb">exec </span>jekyll serve <span class="nt">--drafts</span> <span class="nt">--future</span> <span class="nt">--incremental</span> <span class="nt">--trace</span>
</code></pre></div></div>
<p>The local server rebuilds the site when the source is modified 
(with the notable exception of <code class="highlighter-rouge">_config.yml</code>). Not only does this cut on 
waiting for GitHub to build the site, but it also allows me to spot 
mistakes before publishing. Future also shows posts with a future date, incremental 
updates pages as they are edited, trace prints more detailed error messages.</p>

<h2 id="customization">Customization</h2>

<p>I enabled a few options:</p>
<ul>
  <li><del>Enabled tag for Google <a href="https://analytics.google.com">Analytics</a> and 
<a href="https://search.google.com/search-console/about">Search Console</a></del>
    <ul>
      <li>I removed this as I don’t really benefit from the added tracking…</li>
    </ul>
  </li>
  <li>Enabled <a href="https://www.addtoany.com/">AddToAny</a> support for easy sharing of posts</li>
</ul>

<p>And made some additions:</p>
<ul>
  <li>Left aligned and indented MathJax equations by adding 
<code class="highlighter-rouge">displayAlign: "left", displayIndent: "2em"</code> to 
<code class="highlighter-rouge">_config</code> in <code class="highlighter-rouge">_includes/custom/custom_bottomscripts.html</code>.</li>
  <li>The tag and category cloud features are not working with <code class="highlighter-rouge">Jekyll &gt; 4.0.1</code>. I did not
see an easy way around this other than to require 4.0.1.</li>
  <li>Figured out how to use <code class="highlighter-rouge">&lt;display&gt;</code> to show/hide blocks without breaking markdown 
formatting.
    <ul>
      <li>I had to remove <code class="highlighter-rouge">input: GFM</code> from kramdown settings and use html for the formatting
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;details</span> <span class="na">markdown=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;summary&gt;&lt;i&gt;</span>Click to expand...<span class="nt">&lt;/i&gt;&lt;br/&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;br/&gt;&lt;/summary&gt;</span>
content
<span class="nt">&lt;/details&gt;</span>
</code></pre></div>        </div>
        <p>which is felt a little tedious. I figured out how to make a plugin in 
<code class="highlighter-rouge">_plutins/details_tag.rb</code></p>
        <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Jekyll</span>
  <span class="k">class</span> <span class="nc">DetailsTag</span> <span class="o">&lt;</span> <span class="no">Liquid</span><span class="o">::</span><span class="no">Block</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">markup</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
      <span class="k">super</span>
      <span class="vi">@summary</span> <span class="o">=</span> <span class="n">markup</span><span class="p">.</span><span class="nf">strip</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
      <span class="n">content</span> <span class="o">=</span> <span class="k">super</span>
      <span class="o">&lt;&lt;-</span><span class="no">HTML</span><span class="sh">
&lt;details markdown="1"&gt;
&lt;summary&gt;&lt;i&gt;</span><span class="si">#{</span><span class="vi">@summary</span><span class="si">}</span><span class="sh">&lt;/i&gt;&lt;br/&gt;&amp;nbsp;&lt;br/&gt;&lt;/summary&gt;

</span><span class="si">#{</span><span class="n">content</span><span class="si">}</span><span class="sh">

&lt;/details&gt;
</span><span class="no">      HTML</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">register_tag</span><span class="p">(</span><span class="s1">'details'</span><span class="p">,</span> <span class="no">Jekyll</span><span class="o">::</span><span class="no">DetailsTag</span><span class="p">)</span>
</code></pre></div>        </div>
        <p>which then lets me just do</p>
        <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{<span class="se">\%</span> details Click to expand details... <span class="se">\%</span>}

Hidden content.
    
{<span class="se">\%</span> enddetails <span class="se">\%</span>}
</code></pre></div>        </div>
        <p>(I had to add the slashes not to run the command :S )</p>
      </li>
    </ul>
  </li>
  <li>Enabled search with with <a href="lunrjs">https://lunrjs.com/</a></li>
  <li>Enabled comments with <a href="https://giscus.app/">giscus</a>
    <ul>
      <li>I followed the theme 
<a href="https://dieghernan.github.io/chulapa/docs/02-config#comments">guide</a> to enable
discussions on my repo, installing the giscuss app in github only for the blog repo,
building the giscus script on the app site, and adding it to the custom includes.</li>
    </ul>
  </li>
  <li>Included <a href="https://github.com/paulrobertlloyd/jekyll-figure"><code class="highlighter-rouge">jekyll-figure</code> plugin</a> to 
get pictures with <code class="highlighter-rouge">figure</code> and <code class="highlighter-rouge">figurecaption</code> tags.</li>
</ul>

<h2 id="github-pages-annoyances">GitHub pages annoyances</h2>

<ul>
  <li>GitHub pages doesn’t like the <code class="highlighter-rouge">theme:</code> pointing to an unsupported theme in 
<code class="highlighter-rouge">_config.yml</code>. I got warnings with every build  (that otherwise actually 
worked). Changing this to <code class="highlighter-rouge">remote-theme:</code> makes the builds warning-free.</li>
  <li>GitHub pages runs in safe mode, and doesn’t support most plugins (such as 
the <code class="highlighter-rouge">figure</code> and <code class="highlighter-rouge">details</code> plugins that I use). This can be circumvented by 
building handy GitHub action 
<a href="https://github.com/jeffreytse/jekyll-deploy-action">jekyll-deploy-action </a>. 
The trickiest part was to change <code class="highlighter-rouge">master</code> to main in the <code class="highlighter-rouge">yml</code>, and adding a 
repository secret for repo access. This fix likely fixes the first annoyance,
but it still works with <code class="highlighter-rouge">remote-theme</code>, so I’ll leave it like it is.</li>
</ul>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Photo by <a href="https://unsplash.com/@villepalmu?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Ville Palmu</a> on <a href="https://unsplash.com/s/photos/sarek?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2024/10/30/Blog-setup.html</link>
			<category>posts</category>
		    <category>github</category><category>jekyll</category><media:title type="html"><![CDATA[Blog setup ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2024/10/30/ville-palmu-ZTMqY6DEGRQ-unsplash.jpg" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2024/10/30/ville-palmu-ZTMqY6DEGRQ-unsplash.jpg" /><guid isPermaLink="true">https://thomasburgess.github.io/2024/10/30/Blog-setup.html</guid>
      <pubDate>Wed, 30 Oct 2024 00:00:00 +0100</pubDate>
		</item><item>
			<title>Mersenne Primes.</title>
			<description>
				<![CDATA[	
 				<h3><p>Searching for rare numbers with python.</p>
</h3>
    		<p>7 min.</p>
				<div><h2 id="introduction">Introduction</h2>

<p><em>Update: I recorded myself reading 419 digits from the 52nd Mersenne prime for
<a href="/2024/11/02/saytheprime.html">Say the prime</a>.</em></p>

<p>The 52nd Mersenne prime was discovered on October 21, 2024 
(<a href="https://www.mersenne.org/primes/?press=M136279841">Source: GIMPS</a>). 
Despite intense effort, it took six years to surpass the 51st! It is the largest prime
number ever found so far! A prime number is a number that is only divisible by 1 and 
itself. A Mersenne prime is a <a href="https://en.wikipedia.org/wiki/Prime_number">prime number</a> 
of the form \(m = 2^p - 1\), where \(p\) itself is a prime number.</p>

<p>The first few Mersenne primes (source: 
<a href="https://en.wikipedia.org/wiki/List_of_Mersenne_primes_and_perfect_numbers">Wikipedia</a>)
are:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3, 7, 31, 127, 8191, 131071, 524287, 2147483647
</code></pre></div></div>

<p>The specific form of Mersenne primes enables the use of a fast prime-testing algorithm 
called the <a href="https://en.wikipedia.org/wiki/Lucas%E2%80%93Lehmer_primality_test">Lucas-Lehmer test</a>.
Mersenne primes are closely connected to 
<a href="https://en.wikipedia.org/wiki/Perfect_number">perfect numbers</a> — numbers that are equal 
to the sum of their proper divisors. Perfect numbers take the form 
\(N = 2^{p-1}(2^p-1)\), where \(2^p - 1\) is a Mersenne prime.</p>

<p>Mersenne primes are rare, and the numbers grow exponentially as \(p\) increases, 
making them increasingly difficult to discover. The computational effort needed to 
verify whether a number of the form \(2^p - 1\) is prime also grows significantly, 
requiring sophisticated algorithms and powerful hardware, especially for large 
candidates. In this blog post, I will generate some Mersenne primes and explore how fast
they grow.</p>

<h2 id="python-setup">Python setup</h2>

<p>For this project, I use the standard Python library, 
<a href="https://www.sympy.org/en/index.html">SymPy</a> for fast prime number calculations, and 
<a href="https://github.com/astanin/python-tabulate">tabulate</a> for formatting tables in a 
readable way. I use the following imports:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">sympy</span>
<span class="kn">import</span> <span class="nn">tabulate</span>
</code></pre></div></div>
<p>To easily print tables, I created <code class="highlighter-rouge">tabuliterate</code>, which runs a function on each value 
of an iterable and optionally applies a condition.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tabuliterate</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> 
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cond</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">table</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">table</span>
</code></pre></div></div>

<h2 id="checking-for-prime-numbers">Checking for prime numbers</h2>

<p>One can check if a candidate number \(n\) is prime by verifying if it is divisible 
by any smaller prime up to \(\sqrt{n}\). Here’s a simple python implementation of this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>
<p>Let’s use this to print all primes in the range (1, 50).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">prime_table</span> <span class="o">=</span> <span class="n">tabuliterate</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">cond</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span>
    <span class="n">tabulate</span><span class="p">.</span><span class="n">tabulate</span><span class="p">(</span>
        <span class="n">prime_table</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">"i"</span><span class="p">,</span> <span class="s">"prime(i)"</span><span class="p">,</span> <span class="s">"t (s)"</span><span class="p">,</span> <span class="s">"is_prime"</span><span class="p">],</span>
        <span class="n">tablefmt</span><span class="o">=</span><span class="s">"github"</span><span class="p">))</span>
</code></pre></div></div>
<p>The <code class="highlighter-rouge">tabuliterate</code> function runs <code class="highlighter-rouge">is_prime</code> for each value in the range, and saves the 
results if <code class="highlighter-rouge">is_prime</code> returns <code class="highlighter-rouge">True</code>. I then use <code class="highlighter-rouge">tabulate</code> to print a well-formatted, 
blog-ready Markdown table. To better understand performance, I use <code class="highlighter-rouge">time.perf_counter</code> 
to measure the time between iterations (in column <code class="highlighter-rouge">t (s)</code>).  Additionally, I use the 
Jupyter magic <code class="highlighter-rouge">%%time</code> to print timing information for the entire cell. While these are 
not substitutes for proper profiling, they provide sufficient insight for this blog, 
optimization is not the main focus.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 91 μs, sys: 7 μs, total: 98 μs
Wall time: 101 μs
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>i</th>
      <th>prime(i)</th>
      <th>t (s)</th>
      <th>is_prime</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2</td>
      <td>1.4666e-05</td>
      <td>True</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3</td>
      <td>2.45901e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>3</td>
      <td>5</td>
      <td>3.66601e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>4</td>
      <td>7</td>
      <td>3.45899e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>5</td>
      <td>11</td>
      <td>5.83302e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>6</td>
      <td>13</td>
      <td>3.208e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>7</td>
      <td>17</td>
      <td>4.959e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>8</td>
      <td>19</td>
      <td>2.541e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>9</td>
      <td>23</td>
      <td>5.58398e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>10</td>
      <td>29</td>
      <td>6.916e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>11</td>
      <td>31</td>
      <td>2.79202e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>12</td>
      <td>37</td>
      <td>7.125e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>13</td>
      <td>41</td>
      <td>5.04201e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>14</td>
      <td>43</td>
      <td>3.375e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>15</td>
      <td>47</td>
      <td>4.95798e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>16</td>
      <td>53</td>
      <td>7.04202e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>17</td>
      <td>59</td>
      <td>8.41598e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>18</td>
      <td>61</td>
      <td>3.667e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>19</td>
      <td>67</td>
      <td>7.208e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>20</td>
      <td>71</td>
      <td>5.04201e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>21</td>
      <td>73</td>
      <td>3.54199e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>22</td>
      <td>79</td>
      <td>7.125e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>23</td>
      <td>83</td>
      <td>5.37501e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>24</td>
      <td>89</td>
      <td>6.666e-06</td>
      <td>True</td>
    </tr>
    <tr>
      <td>25</td>
      <td>97</td>
      <td>8.542e-06</td>
      <td>True</td>
    </tr>
  </tbody>
</table>

<p>Now let’s try a few bigger numbers, including powers of ten and some known Mersenne 
primes:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span> 
<span class="n">candidates</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">131071</span><span class="p">,</span> <span class="mi">524287</span><span class="p">,</span> <span class="mi">2147483647</span>
<span class="n">is_prime_table</span> <span class="o">=</span> <span class="n">tabuliterate</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">.</span><span class="n">tabulate</span><span class="p">(</span>
    <span class="n">is_prime_table</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">"i"</span><span class="p">,</span> <span class="s">"n"</span><span class="p">,</span> <span class="s">"t (s)"</span><span class="p">,</span> <span class="s">"is_prime"</span><span class="p">],</span>
    <span class="n">tablefmt</span><span class="o">=</span><span class="s">"github"</span><span class="p">))</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 8.42 ms, sys: 367 μs, total: 8.79 ms
Wall time: 8.92 ms
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>i</th>
      <th>n</th>
      <th>t (s)</th>
      <th>is_prime</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1000</td>
      <td>1.1542e-05</td>
      <td>False</td>
    </tr>
    <tr>
      <td>1</td>
      <td>10000</td>
      <td>4.29098e-06</td>
      <td>False</td>
    </tr>
    <tr>
      <td>2</td>
      <td>100000</td>
      <td>3.29202e-06</td>
      <td>False</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1000000</td>
      <td>2.29198e-06</td>
      <td>False</td>
    </tr>
    <tr>
      <td>4</td>
      <td>131071</td>
      <td>4.9333e-05</td>
      <td>True</td>
    </tr>
    <tr>
      <td>5</td>
      <td>524287</td>
      <td>0.000114417</td>
      <td>True</td>
    </tr>
    <tr>
      <td>6</td>
      <td>2147483647</td>
      <td>0.00870742</td>
      <td>True</td>
    </tr>
  </tbody>
</table>

<p>Using this very basic and unoptimized prime checker, we can still test prime numbers 
relatively quickly. However, by the time we reach the 9th Mersenne prime, the 
computational effort required is no longer feasible for this method without significant 
optimization.</p>

<h2 id="generating-prime-numbers">Generating Prime Numbers</h2>

<p>Before attempting to find Mersenne primes, we first need to generate prime numbers for 
the Mersenne exponents. Specifically, we need a function to generate the nth prime: 
<code class="highlighter-rouge">p = prime(n)</code>. We could use the <code class="highlighter-rouge">is_prime</code> function and loop over all possible values 
of <code class="highlighter-rouge">n</code>, but as Mersenne primes grow very quickly, this approach will soon face 
performance limitations. The <code class="highlighter-rouge">is_prime</code> function doesn’t store previously checked
 values, leading to redundant calculations.</p>

<p>To overcome this, we can use a cache dictionary <code class="highlighter-rouge">{n: prime(n)}</code> to store previously 
computed primes, allowing us to generate the nth prime more efficiently by avoiding 
unnecessary recomputation. Here is an implementation to compute the n-th prime:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">nth_prime</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span> <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">cache</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="n">keys</span><span class="p">())]</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">is_prime</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">is_prime</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">is_prime</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="n">cache</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span>
        <span class="n">num</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</code></pre></div></div>

<p>Now let’s generate some prime numbers:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">cache</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="n">nth_primes_table</span> <span class="o">=</span> <span class="n">tabuliterate</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nth_prime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span>
    <span class="n">tabulate</span><span class="p">.</span><span class="n">tabulate</span><span class="p">(</span>
        <span class="n">nth_primes_table</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">"i"</span><span class="p">,</span> <span class="s">"n"</span><span class="p">,</span> <span class="s">"t (s)"</span><span class="p">,</span> <span class="s">"prime(n)"</span><span class="p">],</span>
        <span class="n">tablefmt</span><span class="o">=</span><span class="s">"github"</span><span class="p">))</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 20.6 s, sys: 124 ms, total: 20.8 s
Wall time: 20.8 s
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>i</th>
      <th>n</th>
      <th>t (s)</th>
      <th>prime(n)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1000</td>
      <td>0.00183408</td>
      <td>7907</td>
    </tr>
    <tr>
      <td>1</td>
      <td>10000</td>
      <td>0.0355349</td>
      <td>104717</td>
    </tr>
    <tr>
      <td>2</td>
      <td>100000</td>
      <td>0.770876</td>
      <td>1299653</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1000000</td>
      <td>19.9434</td>
      <td>15485837</td>
    </tr>
  </tbody>
</table>

<p>We are able to generate the millionth prime, but the approach becomes impractical for 
larger primes. Notably, the 8th Mersenne prime is already 2,147,483,647, making this 
method unsuitable without significant optimization for larger primes.</p>

<h2 id="finding-mersenne-primes">Finding Mersenne primes</h2>

<p>Instead of trying to reinvent a faster and smarter prime generator and tester, here is
the same test implemented with SymPy:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">sympy_nth_primes_table</span> <span class="o">=</span> <span class="n">tabuliterate</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sympy</span><span class="p">.</span><span class="n">prime</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">.</span><span class="n">tabulate</span><span class="p">(</span>
    <span class="n">sympy_nth_primes_table</span><span class="p">,</span> 
    <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">"i"</span><span class="p">,</span> <span class="s">"n"</span><span class="p">,</span> <span class="s">"t (s)"</span><span class="p">,</span> <span class="s">"prime(n)"</span><span class="p">],</span>
    <span class="n">tablefmt</span><span class="o">=</span><span class="s">"github"</span><span class="p">))</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 47 μs, sys: 1 μs, total: 48 μs
Wall time: 57 μs
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>i</th>
      <th>n</th>
      <th>t (s)</th>
      <th>prime(n)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1000</td>
      <td>0.0163215</td>
      <td>7919</td>
    </tr>
    <tr>
      <td>1</td>
      <td>10000</td>
      <td>0.00630858</td>
      <td>104729</td>
    </tr>
    <tr>
      <td>2</td>
      <td>100000</td>
      <td>0.0111348</td>
      <td>1299709</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1000000</td>
      <td>0.0328108</td>
      <td>15485863</td>
    </tr>
  </tbody>
</table>

<p>This approach is significantly faster. Now, let’s try finding some Mersenne primes! 
To do this, we use <code class="highlighter-rouge">sympy.isprime</code> as a filter to determine if numbers of the form are
prime:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">N</span><span class="o">=</span><span class="mi">600</span>
<span class="n">mersenne_primes_table</span> <span class="o">=</span> <span class="n">tabuliterate</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">**</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">(</span><span class="n">sympy</span><span class="p">.</span><span class="n">prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span>
    <span class="n">sympy</span><span class="p">.</span><span class="n">isprime</span>
<span class="p">)</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 1min 14s, sys: 574 ms, total: 1min 14s
Wall time: 1min 14s
</code></pre></div></div>

<p>It takes a little over one minute to test the first 600 primes. However, we can optimize 
this further by leveraging SymPy’s `is_mersenne_prime, which is specifically designed 
for testing Mersenne primes:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="n">N</span><span class="o">=</span><span class="mi">600</span>
<span class="n">mersenne_primes_table</span> <span class="o">=</span> <span class="n">tabuliterate</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">**</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">(</span><span class="n">sympy</span><span class="p">.</span><span class="n">prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span>
    <span class="n">sympy</span><span class="p">.</span><span class="n">ntheory</span><span class="p">.</span><span class="n">primetest</span><span class="p">.</span><span class="n">is_mersenne_prime</span>
<span class="p">)</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU times: user 1min 7s, sys: 94.7 ms, total: 1min 7s
Wall time: 1min 7s
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>i</th>
      <th>n</th>
      <th>p(n)</th>
      <th>t (s)</th>
      <th>D(m)</th>
      <th>m(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>4.0125e-05</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>9.33401e-06</td>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <td>3</td>
      <td>2</td>
      <td>5</td>
      <td>6.666e-06</td>
      <td>2</td>
      <td>31</td>
    </tr>
    <tr>
      <td>4</td>
      <td>3</td>
      <td>7</td>
      <td>5.24998e-06</td>
      <td>3</td>
      <td>127</td>
    </tr>
    <tr>
      <td>5</td>
      <td>5</td>
      <td>13</td>
      <td>1.8209e-05</td>
      <td>4</td>
      <td>8191</td>
    </tr>
    <tr>
      <td>6</td>
      <td>6</td>
      <td>17</td>
      <td>0.0152827</td>
      <td>6</td>
      <td>131071</td>
    </tr>
    <tr>
      <td>7</td>
      <td>7</td>
      <td>19</td>
      <td>0.00496579</td>
      <td>6</td>
      <td>524287</td>
    </tr>
    <tr>
      <td>8</td>
      <td>10</td>
      <td>31</td>
      <td>0.0177748</td>
      <td>10</td>
      <td>2147483</td>
    </tr>
    <tr>
      <td>9</td>
      <td>17</td>
      <td>61</td>
      <td>0.0320199</td>
      <td>19</td>
      <td>2305843…3693951</td>
    </tr>
    <tr>
      <td>10</td>
      <td>23</td>
      <td>89</td>
      <td>0.02063</td>
      <td>27</td>
      <td>6189700…9562111</td>
    </tr>
    <tr>
      <td>11</td>
      <td>27</td>
      <td>107</td>
      <td>0.0131295</td>
      <td>33</td>
      <td>1622592…0288127</td>
    </tr>
    <tr>
      <td>12</td>
      <td>30</td>
      <td>127</td>
      <td>0.00890125</td>
      <td>39</td>
      <td>1701411…4105727</td>
    </tr>
    <tr>
      <td>13</td>
      <td>97</td>
      <td>521</td>
      <td>0.241578</td>
      <td>157</td>
      <td>6864797…5057151</td>
    </tr>
    <tr>
      <td>14</td>
      <td>110</td>
      <td>607</td>
      <td>0.0484024</td>
      <td>183</td>
      <td>5311379…1728127</td>
    </tr>
    <tr>
      <td>15</td>
      <td>206</td>
      <td>1279</td>
      <td>0.405773</td>
      <td>386</td>
      <td>1040793…8729087</td>
    </tr>
    <tr>
      <td>16</td>
      <td>327</td>
      <td>2203</td>
      <td>0.534715</td>
      <td>664</td>
      <td>1475979…7771007</td>
    </tr>
    <tr>
      <td>17</td>
      <td>338</td>
      <td>2281</td>
      <td>0.0510051</td>
      <td>687</td>
      <td>4460875…2836351</td>
    </tr>
    <tr>
      <td>18</td>
      <td>454</td>
      <td>3217</td>
      <td>0.548838</td>
      <td>969</td>
      <td>2591170…9315071</td>
    </tr>
    <tr>
      <td>19</td>
      <td>582</td>
      <td>4253</td>
      <td>0.639087</td>
      <td>1281</td>
      <td>1907970…0484991</td>
    </tr>
    <tr>
      <td>20</td>
      <td>601</td>
      <td>4423</td>
      <td>0.0981187</td>
      <td>1332</td>
      <td>2855425…8580607</td>
    </tr>
    <tr>
      <td>21</td>
      <td>1195</td>
      <td>9689</td>
      <td>3.24355</td>
      <td>2917</td>
      <td>4782202…5754111</td>
    </tr>
    <tr>
      <td>22</td>
      <td>1225</td>
      <td>9941</td>
      <td>0.17318</td>
      <td>2993</td>
      <td>3460882…9463551</td>
    </tr>
    <tr>
      <td>23</td>
      <td>1356</td>
      <td>11213</td>
      <td>0.750064</td>
      <td>3376</td>
      <td>2814112…6392191</td>
    </tr>
    <tr>
      <td>24</td>
      <td>2253</td>
      <td>19937</td>
      <td>5.40748</td>
      <td>6002</td>
      <td>4315424…8041471</td>
    </tr>
    <tr>
      <td>25</td>
      <td>2434</td>
      <td>21701</td>
      <td>1.1508</td>
      <td>6533</td>
      <td>4486791…1882751</td>
    </tr>
    <tr>
      <td>26</td>
      <td>2590</td>
      <td>23209</td>
      <td>0.983179</td>
      <td>6987</td>
      <td>4028741…9264511</td>
    </tr>
    <tr>
      <td>27</td>
      <td>4623</td>
      <td>44497</td>
      <td>13.4968</td>
      <td>13395</td>
      <td>8545098…1228671</td>
    </tr>
    <tr>
      <td>28</td>
      <td>8383</td>
      <td>86243</td>
      <td>27.3762</td>
      <td>25962</td>
      <td>5369279…3438207</td>
    </tr>
  </tbody>
</table>

<p>We managed to test up to  and found the first 28 Mersenne primes in about a minute!</p>

<h2 id="conclusion">Conclusion</h2>

<p>Mersenne primes are fascinating mathematical objects with deep connections to number 
theory. Discovering them requires both computational ingenuity and efficient algorithms, 
as they grow exponentially large and exceedingly rare. I was amazed I could generate a 
25962 digit Mersenne prime on my laptop in a minute. However, noticing that the last 
number took more than twice as much as the previous one, and the 52 is another 24 steps
away… the resent discovery really is something.</p>

</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2024/10/26/mersenne.html</link>
			<category>posts</category>
		    <category>GIMPS</category><category>maths</category><category>primes</category><category>python</category><media:title type="html"><![CDATA[Mersenne Primes. ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2024/10/26/mersennes.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2024/10/26/mersennes.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2024/10/26/mersenne.html</guid>
      <pubDate>Sat, 26 Oct 2024 00:00:00 +0200</pubDate>
		</item><item>
			<title>Rectangle areas!</title>
			<description>
				<![CDATA[	
 				<h3><p>Dad &amp; kid Exploring Areas of Rectangles and Squares.</p>
</h3>
    		<p>3 min.</p>
				<div><p><em>Dad &amp; kid Exploring Areas of Rectangles and Squares.</em></p>

<p>Recently, I did a small exploration of the areas of rectangles and squares with my 
7-year-old kid who loves learning about math. Here we consider rectangles with two 
positive integer side lengths, \(a\) and \(b\). The area of a rectangle is 
\(A = a \cdot b\), and its   circumference is \(C = 2a + 2b\). Together, we computed 
\(A\) for various \(a\) and \(b\) with increasing square side \(s\).</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">\(s\)</th>
      <th style="text-align: left">\(a\)</th>
      <th style="text-align: left">\(b\)</th>
      <th style="text-align: left">\(A\)</th>
      <th style="text-align: left">Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left"><em>One less than square</em></td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left"><em>Square!</em></td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left"><em>Same as first row!</em></td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left"><em>Four less than square</em></td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left"><em>One less than square</em></td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">9</td>
      <td style="text-align: left"><em>Square!</em></td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left"><em>Nine less than square</em></td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">12</td>
      <td style="text-align: left"><em>Four less than square</em></td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">15</td>
      <td style="text-align: left"><em>One less than square!</em></td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left"><em>Square!</em></td>
    </tr>
  </tbody>
</table>

<p>I should note, the basic observations here were done by someone who only knows basic 
arithmetic operations and is curious. I added some formula to explain the ideas better 
to myself.</p>

<h2 id="observations">Observations</h2>

<p>My kid made some exciting observations:</p>

<ol>
  <li>Given a fixed circumference, the area \(A\) is largest when the rectangle is a 
square, that is, when \(a = b = s\).</li>
  <li>When the sides are one unit shorter and one unit longer than \(s\), the area is 
always one unit smaller than \(s^2\).</li>
</ol>

<h3 id="first-observation">First observation</h3>

<p>Let’s investigate the first observation. Suppose the sides of the rectangle are 
\(a = s - n\) and \(b = s + n\), where \(n\) is an offset such that \(|n| &lt; s\). 
With this setup, we have:
\[
\begin{aligned}
    C = 2(s - n) + 2(s + n) = 4s \\ 
    A = (s + n)(s - n) = s^2 - n^2
\end{aligned}
\]
Since \(s^2\) and \(n^2\) are positive, the area \(A\) is largest when \(n = 0\), which
proves the first observation.</p>

<h3 id="second-observation">Second observation</h3>

<p>Now, let’s examine the second observation. The difference in areas between a square and
a rectangle with sides \(s - n\) and \(s + n\) is:
\[
\Delta A = s^2 - (s + n)(s - n) = s^2 - (s^2 - n^2) = n^2.
\]
So, indeed, for \(n = 1\), the difference in area is \(1\).</p>

<h2 id="final-observation">Final observation</h2>

<p>Finally, let’s consider also negative \(n\), and examine \(A\) for \(s=4\) and \(s=5\):</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">n</th>
      <th style="text-align: left">a</th>
      <th style="text-align: left">b</th>
      <th style="text-align: left">A</th>
      <th style="text-align: left">s=4 chart</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">-3</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">12</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">15</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">0</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\) \(\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">15</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">12</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: left">n</th>
      <th style="text-align: left">a</th>
      <th style="text-align: left">b</th>
      <th style="text-align: left">A</th>
      <th style="text-align: left">s=5 chart</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">-4</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">9</td>
      <td style="text-align: left">9</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">-3</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">-2</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">21</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">-1</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">24</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">0</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">25</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\) \(\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: left">6</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">24</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">7</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">21</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\) \(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">9</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">9</td>
      <td style="text-align: left">\(\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\blacksquare\)</td>
    </tr>
  </tbody>
</table>

<p>We chose to call this a skyscraper plot (we drew ours vertically).
We observed that this skyscraper is actually a bunch of squares stacked. First, a 1x1 
square then a 3x3, then 5x5, and so on. With this we can derive a fun formula for the 
area of any skyscraper:</p>

<p>\[
A(s) = \sum_{n=1}^{s} (2n-1)^2 = \frac{1}{3}s(4s^2 - 1)\,.
\]</p>

<p>(Simplified formula from <a href="https://oeis.org/A000447">OEIS</a>).</p>

<p>This simple problem was a lot more fun than I expected, and I found the final 
formula surprisingly beautiful. The cover image on top of this post, is a colourful
rendition of above chart.</p>

<h2 id="appendix">Appendix</h2>

<p>On Mastodon, <a href="https://mathstodon.xyz/deck/@matthiasgiger@bildung.social">Matthias Giger</a>
made a Snap version of the cover image: 
<a href="https://snap.berkeley.edu/project?username=mattgig&amp;projectname=square%20towers">Square Tower</a>.</p>

<figure>
<p><img src="/assets/images/2024/07/30/snap.png" alt="Square towers in Snap!" id="figure-1" width="50%" /></p>
  <figcaption>Figure 1: Square towers in Snap!</figcaption>
</figure>

</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2024/07/30/rectangles.html</link>
			<category>posts</category>
		    <category>area</category><category>kids</category><category>maths</category><media:title type="html"><![CDATA[Rectangle areas! ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2024/07/30/skyline.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2024/07/30/skyline.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2024/07/30/rectangles.html</guid>
      <pubDate>Tue, 30 Jul 2024 00:00:00 +0200</pubDate>
		</item><item>
			<title>Advent of Code 2023</title>
			<description>
				<![CDATA[	
 				<h3><p>A new problem, every day, all of december.</p>
</h3>
    		<p>7 min.</p>
				<div><h1 id="advent-of-code-2023">Advent of Code 2023</h1>

<p>Last year I posted about <a href="/2022/12/01/aoc22.html">16 problems</a> from 
<a href="https://adventofcode.com/2022">Advent of Code 2022</a>.
This year, I will do <a href="https://adventofcode.com/2023">Advent of Code 2023</a> in vanilla 
(only included libraries) python 3.11. I’ve joined the challenge a few times before - 
but never finished. Let’s see how many days I manage this round :D</p>

<p><em>Update: the answer is 4, December is such a busy month :)</em></p>

<p><strong>NOTE</strong>: This blog contains spoilers - use it responsibly.</p>

<p>I’ve hidden the details for each day behind <code class="highlighter-rouge">expand details</code> blocks if you want to see 
only some solutions.</p>

<p>While my solutions do not use external libraries, I sometimes add graphics made with 
<a href="https://matplotlib.org">matplotlib</a>.</p>

<h2 id="template">Template</h2>

<p>In general, these tasks require input data to be read in and be processed in two 
different parts. Here is the python template I use to get started:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
</span><span class="s">"""Advent of code day XX - """</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="s">"""Read line data."""</span>
    <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DAY</span> <span class="o">=</span> <span class="s">"XX"</span>
    <span class="n">exdata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example.txt"</span><span class="p">))</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_input.txt"</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 2"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>I’ll keep my code on this <a href="https://github.com/thomasburgess/advent2023">github repository</a>, 
most of the code will appear in this blog post.</p>

<h2 id="learnings">Learnings</h2>

<p>I learned a few useful things on these challenges so far:</p>
<ul>
  <li>Day 2: <a href="https://docs.python.org/3/library/math.html#math.prod">math.prod</a> - like <code class="highlighter-rouge">sum</code> 
for products!</li>
</ul>

<h2 id="day-1-trebuchet">Day 1: Trebuchet?!</h2>

<ul>
  <li><a href="https://adventofcode.com/2023/day/1">AOC23 day 1 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2023/blob/main/day01.py">code link</a></li>
</ul>

<p>The task is to add numbers from a calibration file together.
Each row of the file encodes a 2-digit number with the first and last single digit in 
the row.</p>

<p>Example input data</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1abc2
pqr3stu8vwx
a1b2c3d4e5f
treb7uchet
</code></pre></div></div>
<p>So the total should be 12+38+15+77=142.</p>

<p>In part 2, numbers can also be spelled out: one, two, three, four, five, six, seven, 
eight, and nine.</p>

<p>Example input data, Part B:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>two1nine
eightwothree
abcone2threexyz
xtwone3four
4nineeightseven2
zoneight234
7pqrstsixteen
</code></pre></div></div>
<p>So the total should be <code class="highlighter-rouge">29+83+13+24+42+14+76=281</code>.</p>

<details>
  <summary><i>Click to expand day 1 solution</i><br />&nbsp;<br /></summary>

  <p>Part 1 is straightforward. Just extract the digits,
scale the first digit by 10 and add to the second one.
For part 2, there can be overlaps like ‘eightwothree’,
to get the correct result i replace numbers with first 
letter, number, last letter, so that: eight becomes e8t.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="s">"""Read line data."""</span>
    <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">digits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">translate_digits</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s">"one"</span><span class="p">,</span>
                <span class="s">"two"</span><span class="p">,</span>
                <span class="s">"three"</span><span class="p">,</span>
                <span class="s">"four"</span><span class="p">,</span>
                <span class="s">"five"</span><span class="p">,</span>
                <span class="s">"six"</span><span class="p">,</span>
                <span class="s">"seven"</span><span class="p">,</span>
                <span class="s">"eight"</span><span class="p">,</span>
                <span class="s">"nine"</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">i</span><span class="si">}{</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">part1</span><span class="p">(</span><span class="n">translate_digits</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DAY</span> <span class="o">=</span> <span class="s">"01"</span>
    <span class="n">exdata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example.txt"</span><span class="p">))</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_input.txt"</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="n">exdata_b</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example_b.txt"</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 2"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">exdata_b</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="day-2---cube-conundrum">Day 2 - Cube Conundrum</h2>

<ul>
  <li><a href="https://adventofcode.com/2023/day/2">AOC23 Day 2 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2023/blob/main/day02.py">code link</a></li>
</ul>

<p>Each game is a row in the input. It consists of several sets separated by<code class="highlighter-rouge">;</code>. 
A set has a <code class="highlighter-rouge">,</code> separated list of count and colour.</p>

<p>Example input data:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Game 1: 3 blue, 4 red; 1 red, 2 green, 6 blue; 2 green
</code></pre></div></div>
<p>In part 1, we need add the game numbers together for games where all sets satisfy 
<code class="highlighter-rouge">red&lt;=12</code>, <code class="highlighter-rouge">green&lt;=13</code>, and <code class="highlighter-rouge">blue&lt;=14</code>. In part 2, we need to add up the products of the
maximum over each colour for all the sets in every game.</p>

<details>
  <summary><i>Click to expand day 2 solution</i><br />&nbsp;<br /></summary>

  <p>The decided to parse the data into r,g,b tuples.
Then, I added a function to find <code class="highlighter-rouge">max(r),max(g),max(b)</code> over a list of tuples.
For part 2, I found out about
<a href="https://docs.python.org/3/library/math.html#math.prod"><code class="highlighter-rouge">math.prod</code></a> 
which works like <code class="highlighter-rouge">sum</code> but for products!</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">math</span>


<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="s">"""Read line data."""</span>
    <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">...]]]:</span>
    <span class="s">"""Turn input rows into list of rgb tuples."""</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">subsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">game</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">):</span>
            <span class="n">cubes</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)}</span>
            <span class="n">subsets</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cubes</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s">"red"</span><span class="p">,</span> <span class="s">"green"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">)))</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsets</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">max_rgb</span><span class="p">(</span><span class="n">game</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">...]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">...]:</span>
    <span class="s">"""Find max of rgb tuples."""</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">game</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">)):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">igame</span> <span class="o">*</span> <span class="nb">all</span><span class="p">((</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_rgb</span><span class="p">(</span><span class="n">game</span><span class="p">),</span> <span class="n">limit</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">igame</span><span class="p">,</span> <span class="n">game</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">max_rgb</span><span class="p">(</span><span class="n">game</span><span class="p">))</span> <span class="k">for</span> <span class="n">igame</span><span class="p">,</span> <span class="n">game</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DAY</span> <span class="o">=</span> <span class="s">"02"</span>
    <span class="n">exdata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example.txt"</span><span class="p">))</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_input.txt"</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 2"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="day-3---gear-ratios">Day 3 - Gear Ratios</h2>

<ul>
  <li><a href="https://adventofcode.com/2023/day/3">AOC23 Day 1 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2023/blob/main/day03.py">code link</a></li>
</ul>

<p>In part 1 we search an array with numerics, dots and other charactes for integers that
are connected to a character that is not a dot. In part 2, we search for pairs of 
numbers connected to the same <code class="highlighter-rouge">*</code> character.</p>

<p>Example input</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>467..114..
...*......
..35..633.
......#...
617*......
.....+.58.
..592.....
......755.
...$.*....
.664.598..
</code></pre></div></div>
<p>Here, 114 and 58 have no connections, and only (467,35) and (755,598) are connected by a
<code class="highlighter-rouge">*</code>.</p>

<details>
  <summary><i>Click to expand day 3 solution</i><br />&nbsp;<br /></summary>

  <p>This was a little tricky. I decided to find the connection points and collect a list of
all numbers connected to them.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>


<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="s">"""Read line data."""</span>
    <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">checks</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">chr</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">]</span>
        <span class="k">except</span> <span class="nb">IndexError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="nb">chr</span> <span class="k">if</span> <span class="nb">chr</span> <span class="k">else</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">"."</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">find_connections</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">chr</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">number</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="n">number</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">checks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">chr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">conn</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="p">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">number</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="n">connections</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span> <span class="o">=</span> <span class="n">connections</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)]</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">number</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">return</span> <span class="n">connections</span>


<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">find_connections</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">values</span><span class="p">(),</span> <span class="p">[]))</span>


<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">find_connections</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">chr</span><span class="o">=</span><span class="s">"*"</span><span class="p">).</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DAY</span> <span class="o">=</span> <span class="s">"03"</span>
    <span class="n">exdata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example.txt"</span><span class="p">))</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_input.txt"</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 2"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="day-4---scratchcards">Day 4 - Scratchcards</h2>

<ul>
  <li><a href="https://adventofcode.com/2023/day/4">AOC23 Day 4 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2023/blob/main/day04.py">code link</a></li>
</ul>

<p>We get a list of cards like this</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Card 1: 41 48 83 86 17 | 83 86  6 31 17  9 48 53
</code></pre></div></div>
<p>we need to consider the number of matches between the two lists separated by <code class="highlighter-rouge">|</code>.
In part 1, we count a score based on the number of matches. In part 2, we get copies
of the next number matches cards added to the stack.</p>

<details>
  <summary><i>Click to expand day 4 solution</i><br />&nbsp;<br /></summary>

  <p>I used a regexp match all to parse the lines. I first parsed everything and then made a
match counter. In principle it would be more efficient to just insert that into the 
parser, but I didn’t know I wouldn’t need the paresed lists before part 2. For part 2 I
just keep track of the number of instances of each card.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="s">"""Read line data."""</span>
    <span class="k">with</span> <span class="n">path</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s">"Card\s+(\d+):\s*(.+?)\s*\|\s*(.+)"</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">card</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">split</span><span class="p">())),</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">split</span><span class="p">()))))</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">wins</span><span class="p">(</span><span class="n">parsed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wins</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">cards</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s">"wins"</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="s">"count"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">wins</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">))}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="s">"wins"</span><span class="p">]):</span>
            <span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s">"count"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="s">"count"</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s">"count"</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DAY</span> <span class="o">=</span> <span class="s">"04"</span>
    <span class="n">exdata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example.txt"</span><span class="p">))</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_input.txt"</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part1</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 2"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">example: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">exdata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\t</span><span class="s">input: </span><span class="si">{</span><span class="n">part2</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="the-rest-of-the-days">The rest of the days</h2>

<p>I did not have the time to go on this year, maybe I will have better luck in 2024.</p>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2023/12/01/advent2023.html</link>
			<category>posts</category>
		    <category>advent</category><category>coding</category><category>python</category><media:title type="html"><![CDATA[Advent of Code 2023 ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2023/12/01/advent_shot.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2023/12/01/advent_shot.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2023/12/01/advent2023.html</guid>
      <pubDate>Fri, 01 Dec 2023 00:00:00 +0100</pubDate>
		</item><item>
			<title>Optimizing matrix multiplication</title>
			<description>
				<![CDATA[	
 				<h3><p>Speeding up sloww matrix operations in python</p>
</h3>
    		<p>11 min.</p>
				<div><p><em>Header image credit</em><sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></p>

<h1 id="introduction">Introduction</h1>

<p>I was asked to speed the inner loop that runs many times inside a 
<a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov Chain Monte Carlo</a>.</p>

<p>The slowest part of each iteration is taking the product of the 
<a href="https://en.wikipedia.org/wiki/Standard_score">Z-scores</a> of a constant matrix, \(X\), 
and float-valued vectors \(u\) or \(v\). Here, \(X\) is a tall \(n \times m\) matrix 
with \(n=45000\) and \(m=3\) with all elements in \(X\) are \(-1\), \(0\) or \(1\). 
The vectors \(u\) and \(v\) have lengths \(m\) (long) and \(n\) (short) respectively.</p>

<p>\[
    a = \left(\frac{X-\mu_X}{\sigma_X}\right)^T u
    \,,\quad\,
    b = \left(\frac{X-\mu_X}{\sigma_X}\right) v \,.
\]</p>

<p>This post is about different approaches to improving performance. Possibly, some 
insights here are applicable beyond the details of the specific problem.</p>

<h2 id="project-setup">Project setup</h2>

<p>I wrote and evaluated this code in a <a href="https://jupyter.org">jupyter lab (v3.5.2)</a> 
notebook in <a href="https://www.python.org">python (v3.10.4)</a> on my M1-pro MacBook Pro. 
Additionally, the <a href="https://numpy.org">numpy (v1.22.4)</a> and 
<a href="https://scipy.org">scipy (v1.8.1)</a> packages were installed.</p>

<details>
  <summary><i>Click to expand imports for python code...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Imports
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">blas</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csc_matrix</span>
</code></pre></div>  </div>

</details>

<h3 id="generating-data">Generating data</h3>

<p>A random \(X\) is generated with <code class="highlighter-rouge">make_X</code>. 
This generates an \(r\times c\) matrix \(M\) with uniform random numbers,
and return a version with elements \(-1\) when \(M_{ij}&lt;p\),
\(+1\) when \(M_{ij} &gt; 1-p\), and \(0\) otherwise. 
For this data, <code class="highlighter-rouge">dtype</code> can be set to 
<a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.byte"><code class="highlighter-rouge">np.byte</code></a>.
The vectors \(u\) and \(v\) are generated directly with the random number generator.</p>

<details>
  <summary><i>Click to expand data generation python code...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_X</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
    <span class="s">"""Generate random data

    Args:
        rows (int): Number of rows to generate
        cols (int): Number of columns to generate
        rng (np.random.Generator): Random number generator instance to use
        prob (float): probability of getting -1 or 1

    Returns:
        np.ndarray: rows x cols Matrix with -1, 0, 1 elements
    """</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">M</span> <span class="o">&lt;</span> <span class="n">prob</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">M</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">byte</span><span class="p">)</span>


<span class="c1"># Constants
</span><span class="n">ROWS</span> <span class="o">=</span> <span class="mi">45000</span>  <span class="c1"># Random X matrix rows
</span><span class="n">COLS</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Random X matrix columns
</span><span class="n">SEED</span> <span class="o">=</span> <span class="mi">1337</span>  <span class="c1"># Random seed
</span><span class="n">PROB</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">10</span>  <span class="c1"># Probability of -1 and +1 in matrix
</span>
<span class="c1"># Get the random number generator
</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>

<span class="c1"># Make X matrix and e vector
</span><span class="n">X</span> <span class="o">=</span> <span class="n">make_X</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">COLS</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="n">PROB</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">ROWS</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">COLS</span><span class="p">)</span>

<span class="c1"># Mean and std for Z score calculation
</span><span class="n">X_mu</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h3 id="evaluating-calculations">Evaluating calculations</h3>

<p>Different implementations are tested using <code class="highlighter-rouge">time_calc</code>. 
It asserts that the function reproduces a known output. 
Furthermore, it measures performance with the 
<a href="https://docs.python.org/3/library/timeit.html"><code class="highlighter-rouge">%timeit</code></a> 
notebook magic that only works in a notebook.</p>

<details>
  <summary><i>Click to expand `time_calc` python code...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">time_calc</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">""</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s">"""
    Args:
        calc (callable): function to evaluate with keyword arguments
        expected (optional): known output to compare to calc output
        tag (str): Tag to print to remember what was evaluated
        kwargs (dict): keyword arguments to pass to calc
    """</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"--- [</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s">] ---"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">calc</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
    <span class="o">%</span><span class="n">timeit</span> <span class="n">calc</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="problem-1---long-vector-u">Problem 1 - long vector \(u\)</h2>

<p>The baseline implementation <code class="highlighter-rouge">calc_baseline</code> provides the known 
output (<code class="highlighter-rouge">expected</code>) and performance data to compare other approaches.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_baseline</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">).</span><span class="n">T</span> <span class="o">@</span> <span class="n">u</span>

<span class="c1"># Compute expected result, to be used in subsequent calls to time_calc
</span><span class="n">expected</span> <span class="o">=</span> <span class="n">calc_baseline</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">)</span>
</code></pre></div></div>

<details>
  <summary><i>Click to expand `time_calc` call for `calc_baseline`...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_baseline</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"baseline"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">blas</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.02</span> <span class="n">ms</span> <span class="err">±</span> <span class="mf">4.42</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>One loop takes 1 ms. If it runs a million times, the baseline implementation contributes
15 minutes to the run time.</p>

<p>As \(X\), \(\mu_X\), and \(\sigma_X\) are constant, an obvious improvement would be to 
pre-calculated the normalized matrix:</p>

<p>\[
X_Z = \frac{X - \mu_X}{\sigma_X}\,.
\]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">calc_Z</span><span class="p">(</span><span class="n">X_Z</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">X_Z</span> <span class="o">@</span> <span class="n">u</span>
</code></pre></div></div>

<details>
  <summary><i>Click to expand `time_calc` call for `calc_Z`...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span><span class="n">calc</span><span class="o">=</span><span class="n">calc_Z</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"Z"</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">X_Z</span><span class="o">=</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">).</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">Z</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">447</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">3.51</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>which already cuts the baseline runtime in more than half!</p>

<h3 id="blas">BLAS</h3>

<p>Numpy uses <a href="https://netlib.org/blas/"><code class="highlighter-rouge">BLAS</code></a> behind the scenes. 
Sometimes it is faster to call BLAS directly.
SciPy exposes matrix-vector multiplication as 
<a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.blas.dgemv.html#scipy.linalg.blas.dgemv"><code class="highlighter-rouge">dgemv</code></a>. 
(Here, <code class="highlighter-rouge">d</code> stands for double precision <code class="highlighter-rouge">ge</code> for general matrix, and <code class="highlighter-rouge">mv</code> for matrix-vector). By giving <code class="highlighter-rouge">trans=1</code> to the method, there is no need to transpose the input matrix.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_blas</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">blas</span><span class="p">.</span><span class="n">dgemv</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">calc_blas_Z</span><span class="p">(</span><span class="n">X_Z</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">blas</span><span class="p">.</span><span class="n">dgemv</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">X_Z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>BLAS performance depends on the memory layout of the arrays used, this can be changed by 
<a href="https://numpy.org/doc/stable/reference/generated/numpy.copy.html">copying</a> arrays to F 
(FORTRAN) order. The same is true for <code class="highlighter-rouge">numpy</code> routines, so to evaluate direct BLAS calls, 
I will compare plain calls, calls with F ordering, and non-BLAS calls with F-ordering.</p>

<details>
  <summary><i>Click to expand `time_calc` calls and results...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_blas</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"blas"</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_blas_Z</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"blas Z"</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">X_Z</span><span class="o">=</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">),</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_blas</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"blas F"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">"F"</span><span class="p">),</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_blas_Z</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"blas Z F"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X_Z</span><span class="o">=</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">"F"</span><span class="p">),</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_baseline</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"baseline F"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">"F"</span><span class="p">),</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_Z</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"Z F"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X_Z</span><span class="o">=</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">"F"</span><span class="p">).</span><span class="n">T</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">blas</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">642</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">9.64</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">blas</span> <span class="n">Z</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">72.3</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">334</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">blas</span> <span class="n">F</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">129</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">4.5</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">blas</span> <span class="n">Z</span> <span class="n">F</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">29.6</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">149</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">baseline</span> <span class="n">F</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">133</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">3.69</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">Z</span> <span class="n">F</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">30.4</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">671</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>Just using BLAS does make the code run 2-6x faster. Changing to F-ordered memory makes 
it 8-15x faster. This improvement also happens for the original Numpy-only functions.</p>

<p>Lesson: memory layout can make a big difference. With the correct input, BLAS doesn’t 
improve performance. The Z method with F-ordering now is 35x faster than the baseline 
method!</p>

<h3 id="algebraic-manipulation">Algebraic manipulation</h3>

<p>The Z-method misses the structure of \(X\). The product \(X^T u\) should run faster than 
\((X-X_\mu)^T u\) as the matrix is all integers and have many zeroes. And by rearranging 
the expression for \(a\), it is possible to use this instead.</p>

<p>\[
    a = 
    \frac{1}{X_\sigma} \left( X^T u - X_\mu \sum_i u \right)\,.
\]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_rearranged</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u</span> <span class="o">-</span> <span class="n">X_mu</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="nb">sum</span><span class="p">())</span> <span class="o">/</span> <span class="n">X_sigma</span>

</code></pre></div></div>

<details>
  <summary><i>Click to expand `time_calc` calls and results.for `calc_rearranged`..</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_rearranged</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"rearranged"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">rearranged</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">84.8</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">1.25</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>This runs 84\(\mu\)s, which is much better than the baseline, but still worse than using
\(X_Z\) with F-ordering. Here, tricks with memory layout or using BLAS no longer 
improves the performance. Perhaps, <code class="highlighter-rouge">bool</code> matrices are even faster? Taking \(X_+\) as a 
boolean matrix with <code class="highlighter-rouge">True</code> for positive elements in \(X\), and similarly, for negatives 
with \(X_-\), the expression can be further rearranged:
\[
    a = 
    \frac{1}{\sigma_X} \left( X_+^T u - X_-^T u - \mu_X \sum_i  u_i \right)\,.
\]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_split</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">X_plus</span><span class="p">,</span> <span class="n">X_minus</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X_plus</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u</span> <span class="o">-</span> <span class="n">X_minus</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u</span> <span class="o">-</span> <span class="n">X_mu</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="nb">sum</span><span class="p">())</span> <span class="o">/</span> <span class="n">X_sigma</span>
</code></pre></div></div>

<details>
  <summary><i>Click to expand `time_calc` calls and results for `calc_split`...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_split</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"split"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
    <span class="n">X_plus</span><span class="o">=</span><span class="n">X</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">X_minus</span><span class="o">=</span><span class="n">X</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="mi">156</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">293</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>That’s half the speed of <code class="highlighter-rouge">calc_rearranged</code>. Building on the split method, one can avoid 
the matrix product altogether! Let \(d_{i,j}^\pm\) be the indices \(i,j\) corresponding 
to the non-zero elements in \(X_\pm\). Now the product becomes 
\(X_+^T u = \sum_iu_{d_{i,j}}^+\), so that</p>

<p>\[
 a = \frac{1}{\sigma_X} \left( \sum_{i} u_{d_{i,j}}^+ - \sum_i u_{d_{i,j}}^- - \mu_X \sum_i u_i \right)\,.
\]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">extract_indices</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">X</span> <span class="o">==</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">rc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">calc_index</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">X_idx_plus</span><span class="p">,</span> <span class="n">X_idx_minus</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">np</span><span class="p">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">u</span><span class="p">[</span><span class="n">X_idx_plus</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="nb">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="n">X_idx_minus</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="nb">sum</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_mu</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">),</span>
            <span class="n">u</span><span class="p">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">X_mu</span> <span class="o">*</span> <span class="n">u</span><span class="p">.</span><span class="nb">sum</span><span class="p">()</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span>

</code></pre></div></div>

<details>
  <summary><i>Click to expand `time_calc` calls and results for `calc_index`...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_index</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"index"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
    <span class="n">X_idx_plus</span><span class="o">=</span><span class="n">extract_indices</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">X_idx_minus</span><span class="o">=</span><span class="n">extract_indices</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="mf">48.2</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">221</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>Not quite as good as the Z method with F-ordering. What performs the best likely depends 
on what data in \(X\) happens to look like.</p>

<h3 id="sparse-matrices">Sparse matrices</h3>

<p>There are many 0s in the matrix, perhaps this problem can be approach using 
<a href="https://en.wikipedia.org/wiki/Sparse_matrix">sparse matrices</a> can be useful, these are 
availible in <a href="https://docs.scipy.org/doc/scipy/reference/sparse.html">SciPy</a>. For this 
problem a 
<a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.csc_array.html#scipy.sparse.csc_array"><code class="highlighter-rouge">csc_matrix</code></a> 
is the best fit for \(X\). As only \(X\) changes, the method above work with the sparse 
inputs without any changes except for <code class="highlighter-rouge">calc_index</code> that doesn’t use matrices at all.</p>

<details>
  <summary><i>Click to expand `time_calc` calls and results...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_baseline</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"sparse baseline"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">byte</span><span class="p">),</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_Z</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"sparse Z"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X_Z</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">).</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X_mu</span><span class="p">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_rearranged</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"sparse rearranged"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">byte</span><span class="p">),</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc</span><span class="o">=</span><span class="n">calc_split</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"sparse split"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
    <span class="n">X_plus</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">X</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
    <span class="n">X_minus</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">X</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
<span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">sparse</span> <span class="n">baseline</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">153</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">6.08</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">sparse</span> <span class="n">Z</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">274</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">94.4</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">sparse</span> <span class="n">rearranged</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">64.7</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">77</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">---</span> <span class="p">[</span><span class="n">sparse</span> <span class="n">split</span><span class="p">]</span> <span class="o">---</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">85</span> <span class="n">µs</span> <span class="err">±</span> <span class="mi">101</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>Sparse matrices improve all the tested methods w.r.t. the baseline. Still, the index 
method is better, and the best way remains to use the Z-method with F-ordering.</p>

<h2 id="problem-2---short-vector-v">Problem 2 - short vector \(v\)</h2>

<p>The baseline for this problem is very similar to the previous one. Only the transpose is
missing. And the same trick with a pre-calculated \(Z\) is possible</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_baseline</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">X_mu</span><span class="p">)</span><span class="o">/</span><span class="n">X_sigma</span><span class="p">)</span> <span class="o">@</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">calc_Z</span><span class="p">(</span><span class="n">X_Z</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">X_Z</span> <span class="o">@</span> <span class="n">v</span>

<span class="n">expected</span> <span class="o">=</span> <span class="n">calc_baseline</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">)</span>
</code></pre></div></div>

<p>Next, test <code class="highlighter-rouge">baseline</code> and <code class="highlighter-rouge">Z</code> for the original input, F-ordering and sparse matrices:</p>

<details>
  <summary><i>Click to expand `time_calc` calls and results...</i><br />&nbsp;<br /></summary>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_calc</span><span class="p">(</span><span class="n">calc_baseline</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"baseline"</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc_baseline</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"baseline F"</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">"F"</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc_baseline</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"baseline sparse"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">byte</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span><span class="n">calc_Z</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"Z"</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">X_Z</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc_Z</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"Z F"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X_Z</span><span class="o">=</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">"F"</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc_Z</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"Z sparse"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X_Z</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">e</span><span class="p">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span><span class="n">calc_baseline</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"baseline"</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span> <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc_baseline</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"baseline sparse"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">byte</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
    <span class="n">X_mu</span><span class="o">=</span><span class="n">X_mu</span><span class="p">,</span>
    <span class="n">X_sigma</span><span class="o">=</span><span class="n">X_sigma</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ti</span>
<span class="n">time_calc</span><span class="p">(</span><span class="n">calc_Z</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">"Z"</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">X_Z</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
<span class="n">time_calc</span><span class="p">(</span>
    <span class="n">calc_Z</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s">"Z sparse"</span><span class="p">,</span>
    <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span>
    <span class="n">X_Z</span><span class="o">=</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">X_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_sigma</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">---</span> <span class="p">[</span><span class="n">baseline</span><span class="p">]</span> <span class="o">---</span>
<span class="mi">908</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">68.9</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">---</span> <span class="p">[</span><span class="n">baseline</span> <span class="n">F</span><span class="p">]</span> <span class="o">---</span>
<span class="mi">260</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">47.7</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">---</span> <span class="p">[</span><span class="n">baseline</span> <span class="n">sparse</span><span class="p">]</span> <span class="o">---</span>
<span class="mi">302</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">42.6</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">---</span> <span class="p">[</span><span class="n">Z</span><span class="p">]</span> <span class="o">---</span>
<span class="mf">53.6</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">1.26</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">---</span> <span class="p">[</span><span class="n">Z</span> <span class="n">F</span><span class="p">]</span> <span class="o">---</span>
<span class="mf">29.2</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">1.07</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
<span class="o">---</span> <span class="p">[</span><span class="n">Z</span> <span class="n">sparse</span><span class="p">]</span> <span class="o">---</span>
<span class="mf">87.3</span> <span class="n">µs</span> <span class="err">±</span> <span class="mf">1.2</span> <span class="n">µs</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="p">.</span> <span class="n">dev</span><span class="p">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>The most efficient calculation is using the Z-method with F-ordering.</p>

<h2 id="summary">Summary</h2>

<p>The baseline implementations were improved by pre-calculating the normalized matrix 
\(X_Z\), using SciPy’s direct interface to BLAS routines, algebraically rearranging the 
expression, and by using sparse matrices. Sparse matrices can help, especially when the 
data is sparse enough. It is also possible to exploit the structure of the matrix to get 
similarly good performance. Overall, the best performance was achieved by using the 
pre-normalized matrix with F-ordering of the array memory. Table 1 and 2 summarizes the 
achieved speed-ups for the different improvements.</p>

<figure>
<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Duration (µs)</th>
      <th>Speed-up</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Baseline</td>
      <td>1020.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <td>Z</td>
      <td>448.0</td>
      <td>2.28</td>
    </tr>
    <tr>
      <td>BLAS</td>
      <td>642.0</td>
      <td>1.59</td>
    </tr>
    <tr>
      <td>BLAS Z</td>
      <td>72.3</td>
      <td>14.11</td>
    </tr>
    <tr>
      <td>BLAS F</td>
      <td>129.0</td>
      <td>7.91</td>
    </tr>
    <tr>
      <td>BLAS Z F</td>
      <td>29.6</td>
      <td>34.46</td>
    </tr>
    <tr>
      <td>Baseline F</td>
      <td>133.0</td>
      <td>7.67</td>
    </tr>
    <tr>
      <td>Z F</td>
      <td>30.4</td>
      <td>33.55</td>
    </tr>
    <tr>
      <td>Rearranged</td>
      <td>83.4</td>
      <td>12.23</td>
    </tr>
    <tr>
      <td>Split</td>
      <td>156.0</td>
      <td>6.54</td>
    </tr>
    <tr>
      <td>index</td>
      <td>48.2</td>
      <td>21.16</td>
    </tr>
    <tr>
      <td>sparse baseline</td>
      <td>159.0</td>
      <td>6.42</td>
    </tr>
    <tr>
      <td>sparse Z</td>
      <td>276.0</td>
      <td>3.70</td>
    </tr>
    <tr>
      <td>sparse rearranged</td>
      <td>65.6</td>
      <td>15.55</td>
    </tr>
    <tr>
      <td>sparse split</td>
      <td>85.8</td>
      <td>11.89</td>
    </tr>
  </tbody>
</table>

  <figcaption><strong>Table 1</strong>: Problem 1 - Durations and speed-ups w.r.t. baseline for all tests</figcaption>
</figure>

<figure>
<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Duration (µs)</th>
      <th>Speed-up</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>baseline</td>
      <td>908.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <td>Baseline F</td>
      <td>260.0</td>
      <td>3.49</td>
    </tr>
    <tr>
      <td>Baseline sparse</td>
      <td>302.0</td>
      <td>3.01</td>
    </tr>
    <tr>
      <td>Z</td>
      <td>53.6</td>
      <td>16.94</td>
    </tr>
    <tr>
      <td>Z F</td>
      <td>29.2</td>
      <td>31.10</td>
    </tr>
    <tr>
      <td>Z sparse</td>
      <td>87.3</td>
      <td>10.40</td>
    </tr>
  </tbody>
</table>

  <figcaption><strong>Table 2</strong>: Problem 2 - durations and speed-ups w.r.t. baseline for all tests</figcaption>
</figure>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Photo by <a href="https://unsplash.com/@mikitayo?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Mikita Yo</a> on <a href="https://unsplash.com/photos/red-and-white-line-illustration-OCrl1Tkt630?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Unsplash</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2023/02/02/Matrix_Multiplication.html</link>
			<category>posts</category>
		    <category>blog</category><category>coding</category><category>maths</category><category>matrix</category><category>mcmc</category><category>numpy</category><category>python</category><media:title type="html"><![CDATA[Optimizing matrix multiplication ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2023/02/02/mikita-yo-OCrl1Tkt630-unsplash.jpg" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2023/02/02/mikita-yo-OCrl1Tkt630-unsplash.jpg" /><guid isPermaLink="true">https://thomasburgess.github.io/2023/02/02/Matrix_Multiplication.html</guid>
      <pubDate>Thu, 02 Feb 2023 00:00:00 +0100</pubDate>
		</item><item>
			<title>Advent of Code 2022</title>
			<description>
				<![CDATA[	
 				<h3><p>A new problem, every day, all of december.</p>
</h3>
    		<p>28 min.</p>
				<div><h1 id="advent-of-code-2022">Advent of Code 2022</h1>

<p>I will do this years <a href="https://adventofcode.com/2022">Advent of Code 2022</a> in vanilla 
(only included libraries) python 3.10.4. I’ve joined the challenge a few times before - 
but never finished. Let’s see how many days I manage this round :D</p>

<ul>
  <li><em>Update 1: the answer is 16, December is such a busy month :)</em></li>
  <li><em>Update 2: <a href="/2023/12/01/advent2023.html">see my post on AoC 2023</a></em></li>
</ul>

<p><strong>NOTE</strong>: This blog contains spoilers - use it responsibly.</p>

<p>I’ve hidden the details for each day behind <code class="highlighter-rouge">expand details</code> blocks if you want to see 
only some solutions.</p>

<p>While my solutions do not use external libraries, I sometimes add graphics made with 
<a href="https://matplotlib.org">matplotlib</a>.</p>

<h3 id="template">Template</h3>

<p>In general, these tasks require input data to be read in and be processed in two 
different parts. Here is the pathon template I use to get started:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
</span><span class="s">"""Advent of code day XX - """</span>

<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DAY</span> <span class="o">=</span> <span class="s">"XX"</span>
    <span class="n">exdata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_example.txt"</span><span class="p">)</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="sa">f</span><span class="s">"day</span><span class="si">{</span><span class="n">DAY</span><span class="si">}</span><span class="s">_input.txt"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">example"</span><span class="p">,</span> <span class="n">part1</span><span class="p">(</span><span class="n">exdata</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">input"</span><span class="p">,</span> <span class="n">part1</span><span class="p">(</span><span class="n">indata</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"PART 2"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">example"</span><span class="p">,</span> <span class="n">part2</span><span class="p">(</span><span class="n">exdata</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">input"</span><span class="p">,</span> <span class="n">part2</span><span class="p">(</span><span class="n">indata</span><span class="p">))</span>
</code></pre></div></div>

<p>I’ll keep my code on this 
<a href="https://github.com/thomasburgess/advent2022">github repository</a>, most of the code will 
appear in this blog post.</p>

<h3 id="learnings">Learnings</h3>

<p>I learned a few useful things on these challenges so far:</p>

<ul>
  <li><a href="https://docs.python.org/3.8/library/itertools.html#itertools.takewhile"><code class="highlighter-rouge">itertools.takewhile</code></a> - Iterate while predicate is True</li>
  <li>The sign of x: <code class="highlighter-rouge">(x &gt; 0) - (x &lt; 0)</code></li>
  <li>Transpose for list of lists: <code class="highlighter-rouge">tuple(zip(*data))</code></li>
  <li>Like <code class="highlighter-rouge">sum(x)</code> but for products: <code class="highlighter-rouge">functools.reduce(operator.mul, x, 1)</code></li>
  <li>The use of <a href="https://docs.python.org/3/library/functools.html#functools.cmp_to_key"><code class="highlighter-rouge">functools.cmp_to_key</code></a> and key functions to change how <code class="highlighter-rouge">sort</code>, <code class="highlighter-rouge">max</code>, and similar functions work in python</li>
  <li>To get both max and min over two dimensions of data like <code class="highlighter-rouge">[(x0, y0), (x1, y1), ...]</code> one can use <code class="highlighter-rouge">(min0, max0),(min1, max1) = map(lambda x: (min(x), max(x)), zip(*data))</code></li>
  <li>It’s easy and useful to print unicode characters <code class="highlighter-rouge">sand="🟨"</code></li>
  <li><a href="https://docs.python.org/3/library/re.html#functions"><code class="highlighter-rouge">re.split</code></a> is a great when parsing text input</li>
</ul>

<h2 id="day-01---counting-calories">Day 01 - Counting calories</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/1">AOC2 Day 01 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day01.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day01 solution</i><br />&nbsp;<br /></summary>

  <p>Lines in a group have a single integer, blank lines separate groups.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000
2000
3000

4000

5000
6000

7000
8000
9000

10000
</code></pre></div>  </div>

  <p><code class="highlighter-rouge">read_sums</code> parses the data, aggregates groups, and returns the list of sums.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_sums</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Start with single empty sum
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Add new empty sum
</span>                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: Find the group with the largest sum.</p>

  <p>Solution: Take the maximum of the list of sums</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">max</span><span class="p">(</span><span class="n">read_sums</span><span class="p">(</span><span class="s">"day01_input.txt"</span><span class="p">))</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: Find the three largest groups.</p>

  <p>Solution: Sort the list and summing the last 3 items:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sum</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">read_sums</span><span class="p">(</span><span class="s">"day01_input.txt"</span><span class="p">))[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
</code></pre></div>  </div>

</details>

<h2 id="day-02---rock-paper-scissors">Day 02 - Rock Paper Scissors</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/2">AOC Day 02 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day02.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day02 solution</i><br />&nbsp;<br /></summary>

  <p>Data: rows with games, the first column is the opponent move, and the second is the 
player move.</p>

  <p>Move encoding: Rock, paper, and scissors is A, B, C for opponent, and X, Y, Z for player.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A Y
B X
C Z
</code></pre></div>  </div>

  <p><code class="highlighter-rouge">read_strats</code> parses the data and converts character representation to 0, 1, 2</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_strats</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"A"</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"X"</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">())</span>
        <span class="p">]</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: Count score for rock paper scissors games.</p>

  <p>Score: Player move (1 for rock, 2 for paper, and 3 for scissors), plus 0 for loss, 3 for
draw and 6 for win.</p>

  <p>The <code class="highlighter-rouge">score</code> function computes the score for a single game:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]][</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</code></pre></div>  </div>

  <p>With this the total score is</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">strats</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">score</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">strats</span><span class="p">))</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: count score as above but now the second column states X=loss, Y=draw, Z=win.</p>

  <p>Using <code class="highlighter-rouge">transform</code> the second column is transformed to the old format:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]][</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</code></pre></div>  </div>

  <p>and then the total score (using part1 on the transformed data) is</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">strats</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">part1</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transform</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)),</span> <span class="n">strats</span><span class="p">))</span>
</code></pre></div>  </div>

</details>

<h2 id="day-03---rucksack-reorganization">Day 03 - Rucksack Reorganization</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/3">AOC Day 03 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day03.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day03 solution</i><br />&nbsp;<br /></summary>

  <p>Each row of data is a rucksack with a string of characters <code class="highlighter-rouge">[a-zA-Z]</code>.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vJrwpWtwJgWrhcsFMMfFFhFp
jqHRNqRjqzjGDLGLrsFMfFZSrLrFZsSL
PmmdzqPrVvPwwTWBwg
wMqvLMZHhHMvwLHjbvcjnnSBnvTQFn
ttgJtRGJQctTZtZT
CrZsJsPPZsGzwwsLwLmpwMDw
</code></pre></div>  </div>

  <p>Each character corresponds to a priority: a=1,…, z=27, A=27,…, Z=52.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="nb">chr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"A"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">27</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>  </div>

  <p>With this sack data is read with <code class="highlighter-rouge">read_sacks</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_sacks</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">())))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: sum priority of items unique in first and second half of rucksack.</p>

  <p>Part 1 is solved by summing the set intersections of the first and second part of the 
sacks:</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">sacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]).</span><span class="n">intersection</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:])),</span> <span class="n">sacks</span><span class="p">)</span>
    <span class="p">)</span>

</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: sum priority of items unique to three consecutive rucksacks.</p>

  <p>This part is solved by summing the intersections of  consecutive sacks, as follows:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">sacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">sacks</span><span class="p">[</span><span class="n">x</span><span class="p">]).</span><span class="n">intersection</span><span class="p">(</span><span class="n">sacks</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]).</span><span class="n">intersection</span><span class="p">(</span><span class="n">sacks</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
            <span class="p">),</span>
            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacks</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="day-04---camp-cleanup">Day 04 - Camp Cleanup</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/4">AOC Day 04 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day04.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day04 solution</i><br />&nbsp;<br /></summary>

  <p>Each row shows a pair separated by <code class="highlighter-rouge">,</code>, each entry is a range <code class="highlighter-rouge">low-high</code>.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2-4,6-8
2-3,4-5
5-7,7-9
2-8,3-7
6-6,4-6
2-6,4-8
</code></pre></div>  </div>

  <p>With this sack data is read with <code class="highlighter-rouge">read_pairs</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_pairs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">","</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: Count pairs where one pair fully overlaps with the other</p>

  <p>Solution: check if one pair overlaps the other in either order.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">count_contained</span><span class="p">(</span><span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="n">pairs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: Count overlapping pairs</p>

  <p>Solution: Check if range bounds overlap in any way</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">count_overlaps</span><span class="p">(</span><span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">pairs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="day-05---supply-stacks">Day 05 - Supply Stacks</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/5">AOC Day 05 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day05.py">code link</a></li>
</ul>

<p>For me the whole challenge here was to parse the data.</p>

<details>
  <summary><i>Click to expand Day05 solution</i><br />&nbsp;<br /></summary>

  <p>The data is split into two parts separated by a blank line. In the first part, stacks of
items are listed in columns, with column index on the last row (this index can be
ignored). Items are on the form <code class="highlighter-rouge">[X]</code> where <code class="highlighter-rouge">X</code> is a single character item id. In the 
second part a sequence of moves with item count count, source column, destination column
are listed.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    [D]    
[N] [C]    
[Z] [M] [P]
 1   2   3 

move 1 from 2 to 1
move 3 from 1 to 3
move 2 from 2 to 1
move 1 from 1 to 2
</code></pre></div>  </div>

  <p>The two parts are read in and processed with <code class="highlighter-rouge">read_stacks</code>:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_stacks</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">chr</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">stacks</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">moves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># Read stacks
</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">stacks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"[^A-Za-z]+"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]))</span>

        <span class="c1"># Read moves
</span>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
            <span class="n">moves</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"[^0-9]+"</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">line</span><span class="p">).</span><span class="n">split</span><span class="p">()])</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">moves</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: apply the moves and list the top item in the stack</p>

  <p>The moves are applied in sequence using <code class="highlighter-rouge">apply_moves</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_moves</span><span class="p">(</span>
    <span class="n">stacks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">chr</span><span class="p">]],</span> <span class="n">moves</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">moves</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">stacks</span><span class="p">[</span><span class="n">s</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">stacks</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="n">sub</span><span class="p">)</span> <span class="o">+</span> <span class="n">stacks</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="n">stacks</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">stacks</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">n</span><span class="p">:]</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">.</span><span class="n">items</span><span class="p">()])</span>
</code></pre></div>  </div>

  <p>The reverse option is used to reorder the stack to work with the specification. For this task <code class="highlighter-rouge">reverse=True</code>.</p>

  <p><strong>Part 2</strong></p>

  <p>Task: same but with different ordering of added items.</p>

  <p>This is solved with the same <code class="highlighter-rouge">apply_moves</code> function with <code class="highlighter-rouge">reverse=False</code>.</p>

</details>

<h2 id="day-06---tuning-trouble">Day 06 - Tuning Trouble</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/6">AOC Day 06 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day06.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day06 solution</i><br />&nbsp;<br /></summary>

  <p>5 examples are given:</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>7 mjqjpqmgbljsphdztnvjfqwrcgsmlb
5 bvwbjplbgvbhsrlpgdmjqwftvncz
6 nppdvjthqldpwncqszvftbrmjlhg
10 nznrnfrfntjfmvfwmzdfjlvtqnbhcprsg
11 zcfzfwzzqfrljwzlrfnpqdbhtmscgvjw
</code></pre></div>  </div>

  <p>Task: find message start - the first instance of four different consecutive characters.</p>

  <p>Solution: generate the length of the <code class="highlighter-rouge">set</code> of n character spans until it equals n. For
this <a href="https://docs.python.org/3.8/library/itertools.html#itertools.takewhile"><code class="highlighter-rouge">itertools.takewhile</code></a>
is very useful.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">takewhile</span>
<span class="k">def</span> <span class="nf">find_start</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">takewhile</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">n</span><span class="p">,</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">n</span> <span class="p">:</span> <span class="n">x</span><span class="p">])),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">))),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>  </div>
  <p>Plugging in <code class="highlighter-rouge">n=4</code> into this gives the correct solution for part 1, and part 2 likewise 
with <code class="highlighter-rouge">n=14</code>.</p>

</details>

<h2 id="day-07---no-space-left-on-device">Day 07 - No Space Left On Device</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/7">AOC Day 07 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day07.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day07 solution</i><br />&nbsp;<br /></summary>

  <p>A file system is explored using <code class="highlighter-rouge">cd</code> and <code class="highlighter-rouge">ls</code>. The first <code class="highlighter-rouge">cd</code> is always to <code class="highlighter-rouge">/</code> and <code class="highlighter-rouge">ls</code>
are always in current directory. Lines with commands starts with <code class="highlighter-rouge">$</code>. Listings of
directories start with <code class="highlighter-rouge">dir</code>, and listings of file starts with file size.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /
$ ls
dir a
14848514 b.txt
8504156 c.dat
dir d
$ cd a
$ ls
dir e
29116 f
2557 g
62596 h.lst
$ cd e
$ ls
584 i
$ cd ..
$ cd ..
$ cd d
$ ls
4060174 j
8033020 d.log
5626152 d.ext
7214296 k
</code></pre></div>  </div>

  <p>The code is read into a tree strucutre of nested dictionaries using <code class="highlighter-rouge">read_tree</code>. For
files the value is the filesize int instead of a dictionary. I based the thinking here
on my <a href="https://thomasburgess.github.io/blog/2021/07/18/tree_hack.html">Tree Hack blog post</a>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_tree</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"$"</span><span class="p">:</span>
                <span class="c1"># Add file or directory
</span>                <span class="n">t</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"dir"</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"cd"</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Update current working directory
</span>                <span class="n">cwd</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">dest</span> <span class="o">==</span> <span class="s">".."</span> <span class="k">else</span> <span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="p">[</span><span class="n">dest</span><span class="p">])</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">tree</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cwd</span><span class="p">:</span>  <span class="c1"># Jump to the right directory in the tree
</span>                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tree</span>
</code></pre></div>  </div>

  <p>with the tree structure in place, one can traverse the tree and collect the total size of each directory.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dir_size</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"/"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">base</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">k</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dir_size</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>  </div>

  <p>The data input for the problems is the output of <code class="highlighter-rouge">dir_size(read_data("input.txt"))</code>.</p>

  <p><strong>Part 1</strong></p>

  <p>Task 1: Find sum of directory sizes less than 100000</p>

  <p>Solution: sum sizes ignoring anything smaller than the threshold:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task 2: Find smallest directory that when removed leaves 30000000 free storage of a 
total of 70000000.</p>

  <p>Solution: Take smallest element of items where <code class="highlighter-rouge">70000000-used+size&gt;30000000</code></p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">70000000</span><span class="p">,</span> <span class="n">req</span><span class="o">=</span><span class="mi">30000000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">total</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">req</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<h2 id="day-08---treetop-tree-house">Day 08 - Treetop Tree House</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/8">AOC Day 08 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day08.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day08 solution</i><br />&nbsp;<br /></summary>

  <p>Data are heights of trees on a square grid.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>30373
25512
65332
33549
35390
</code></pre></div>  </div>

  <p>The maps are read into a list of list of ints.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_map</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="s">"""Read in data into 2D int array"""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">())</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: Count number of visible trees from the edge.</p>

  <p>Trees are not visible if behind trees of same or lower height.
The count is found as the sum of True values in a visibility matrix 
made by OR-ing together partial visibility matrices for each direction.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">T</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="s">"""Transpose list of lists"""</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">vor</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="s">"""Elementwise or of lists x and y"""</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="ow">or</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">vx</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="s">"""Visibility for each element in row x"""</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">all</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>


<span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]:</span>
    <span class="s">"""Visibilities for both directions in each row in data"""</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vor</span><span class="p">(</span><span class="n">vx</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">vx</span><span class="p">(</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">visibility</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]:</span>
    <span class="s">"""Visibility ORed for rows and columns in data"""</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vis</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">T</span><span class="p">(</span><span class="n">vis</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">data</span><span class="p">)))))</span>


<span class="k">def</span> <span class="nf">sum_visibility</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="s">"""Sum visibilities"""</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visibility</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: find maximum scenic score (product number of tree visible in each direction)</p>

  <p>Here, for each tree the number of consecutive shorter trees is counted and multiplied 
together for each direction.</p>

  <p>This task took quite some time to debug, I think I didn’t parse the instructions
correctly…</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="s">"""Count trees"""</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">v0</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">n</span>


<span class="k">def</span> <span class="nf">scenic</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="s">"""Compute scenic score for each tree"""</span>
    <span class="n">scenic_scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">data_t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">maxx</span><span class="p">,</span>
                <span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">j</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">c</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data_t</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="n">i</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data_t</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">r</span><span class="p">]),</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">maxx</span>
</code></pre></div>  </div>

</details>

<h2 id="day-09---rope-bridge">Day 09 - Rope Bridge</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/9">AOC Day 09 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day09.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day09 solution</i><br />&nbsp;<br /></summary>

  <p>Input data consists of moves with a direction (U,D,R,L) and a number of steps</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R 4
U 4
L 3
D 1
R 4
D 1
L 5
R 2
</code></pre></div>  </div>

  <p>The task is to move the head of a rope according to the moves, and track how the tail
trails.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_moves</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()))</span>
        <span class="p">)</span>
</code></pre></div>  </div>

  <p>The solution for part2 also solves part1 so I refactored simualte accordingly. As I had
several bugs, I added a handy printer function to print the rope and locations visited
by the tile:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">printer</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">hashes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="s">"#"</span> <span class="k">if</span> <span class="n">hashes</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hashes</span><span class="p">:</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">"H"</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sx</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">sx</span><span class="p">)</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sy</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">sy</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">index</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])]</span> <span class="k">if</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="s">"."</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>  </div>

  <p>The simulation is fairly straight forward, once you decode the instructions…</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">DELTA</span> <span class="o">=</span> <span class="p">{</span><span class="s">"U"</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">"D"</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s">"R"</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s">"L"</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">steps</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"=== </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s"> ==="</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">DELTA</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="c1"># Update head
</span>            <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># Update tail
</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sign</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sign</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">visited</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">printer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"VISITED"</span><span class="p">)</span>
        <span class="n">printer</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">),</span> <span class="n">hashes</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span>
</code></pre></div>  </div>

  <p>With this code the solutions are comptuted by running:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"part 1:"</span><span class="p">,</span> <span class="n">read_moves</span><span class="p">(</span><span class="s">"input.txt"</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"part 2:"</span><span class="p">,</span><span class="n">read_moves</span><span class="p">(</span><span class="s">"input.txt"</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
</code></pre></div>  </div>

</details>

<p>The printer gives this expected output for the tail visits for the longer example in 
part 2.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#.....................
#.............###.....
#............#...#....
.#..........#.....#...
..#..........#.....#..
...#........#.......#.
....#......#.........#
.....#..............#.
......#............#..
.......#..........#...
........#........#....
.........########.....
</code></pre></div></div>

<h2 id="day-10---cathode-ray-tube">Day 10 - Cathode-Ray Tube</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/10">AOC Day 10 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day10.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day10 solution</i><br />&nbsp;<br /></summary>

  <p>Data is instruction lists with <code class="highlighter-rouge">noop</code> (takes 1 cycle) and <code class="highlighter-rouge">addx</code> (takes 2 cycles). <code class="highlighter-rouge">addx dx</code> adds <code class="highlighter-rouge">dx</code> to the register x.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noop
addx 3
addx -5
</code></pre></div>  </div>

  <p>The data is parsed to <code class="highlighter-rouge">cycle</code> count and <code class="highlighter-rouge">dx</code> for each instruction in <code class="highlighter-rouge">read_program</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_program</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="s">"noop"</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="k">if</span> <span class="s">"noop"</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="p">]</span>
</code></pre></div>  </div>

  <p>Next, the program is executed using <code class="highlighter-rouge">run_program</code>to track <code class="highlighter-rouge">cycle</code> count and <code class="highlighter-rouge">x</code> after
each instructions. <code class="highlighter-rouge">x</code> starts at 1.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run_program</span><span class="p">(</span><span class="n">prog</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">prog</span><span class="p">:</span>
        <span class="n">y</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: Get cycle count * x for every 40th cycle starting at 20</p>

  <p>The result is obtained by applying <code class="highlighter-rouge">part1</code> to the output of <code class="highlighter-rouge">run_program</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">40</span><span class="p">):</span>
        <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: Draw pixels when x is within +-1 of cycle MOD 40.</p>

  <p>The result is obtained by applying <code class="highlighter-rouge">part2</code> to the output of <code class="highlighter-rouge">run_program</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">prog</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">" "</span><span class="p">]</span> <span class="o">*</span> <span class="mi">240</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prog</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">prog</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="s">"█"</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">prog</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">40</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</code></pre></div>  </div>

</details>

<p>This part is very satisfying as you get nice output! For the example:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>██  ██  ██  ██  ██  ██  ██  ██  ██  ██
███   ███   ███   ███   ███   ███   ███
████    ████    ████    ████    ████
█████     █████     █████     █████
██████      ██████      ██████      ████
███████       ███████       ███████
</code></pre></div></div>

<p>and for my input:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>███  ████ ███   ██  ████ ████   ██ ███
█  █    █ █  █ █  █    █ █       █ █  █
█  █   █  ███  █      █  ███     █ ███
███   █   █  █ █ ██  █   █       █ █  █
█    █    █  █ █  █ █    █    █  █ █  █
█    ████ ███   ███ ████ ████  ██  ███
</code></pre></div></div>

<h2 id="day-11---monkey-in-the-middle">Day 11 - Monkey in the Middle</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/11">AOC Day 11 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day11.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day11 solution</i><br />&nbsp;<br /></summary>

  <p>Monkeys process their stack of worries and perform an operation on them, divides the results, and passes it on to another monkey depending on divisibility.</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Monkey 0:
  Starting items: 79, 98
  Operation: new = old * 19
  Test: divisible by 23
    If true: throw to monkey 2
    If false: throw to monkey 3

Monkey 1:
  Starting items: 54, 65, 75, 74
  Operation: new = old + 6
  Test: divisible by 19
    If true: throw to monkey 2
    If false: throw to monkey 0

...
</code></pre></div>  </div>

  <p>I read the data with the <code class="highlighter-rouge">read_monkey</code>. This function defines the operation and test as lambdas to be applied later. If <code class="highlighter-rouge">divby</code> is 1 the <code class="highlighter-rouge">//</code> at the end of the operation is avoided altogether (useful in part 2). Inspected is a counter that should be incremented for every action the monkey takes.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_monkeys</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">divby</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">monkey</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">):</span>
            <span class="n">monkey_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">monkey</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">strip</span><span class="p">()]</span>

            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s">"monkey"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">monkey_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">":"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s">"stack"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="nb">int</span><span class="p">,</span>
                            <span class="n">monkey_data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">"Starting items: "</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="s">"inspected"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s">"mod"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">monkey_data</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">"Test: divisible by "</span><span class="p">,</span> <span class="s">""</span><span class="p">)),</span>
                    <span class="s">"operation"</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span>
                        <span class="s">"lambda x: ("</span>
                        <span class="o">+</span> <span class="n">monkey_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"Operation: new = "</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
                        <span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"old"</span><span class="p">,</span> <span class="s">"x"</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s">")"</span>
                        <span class="o">+</span> <span class="p">(</span><span class="s">""</span> <span class="k">if</span> <span class="n">divby</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s">"//</span><span class="si">{</span><span class="n">divby</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="s">"test"</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s">"lambda x: (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">monkey_data</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">monkey_data</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s">)"</span>
                        <span class="sa">f</span><span class="s">"[x % </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">monkey_data</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">'Test</span><span class="si">:</span> <span class="n">divisible</span> <span class="n">by</span> <span class="s">', ''))</span><span class="si">}</span><span class="s"> != 0]"</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>  </div>

  <p>In <code class="highlighter-rouge">run_monkeys</code> each monkey is evaulated in several rounds. The <code class="highlighter-rouge">mod</code> argument keeps worry from going too large in part2.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run_monkeys</span><span class="p">(</span><span class="n">monkeys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rounds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">monkeys</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">m</span><span class="p">[</span><span class="s">"stack"</span><span class="p">]:</span>
                <span class="n">m</span><span class="p">[</span><span class="s">"inspected"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s">"stack"</span><span class="p">].</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s">"operation"</span><span class="p">](</span><span class="n">i</span><span class="p">)</span>
                <span class="n">monkeys</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s">"test"</span><span class="p">](</span><span class="n">x</span><span class="p">)][</span><span class="s">"stack"</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">mod</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">monkeys</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Find the product of the inspection count of the two busiest monkeys after 20 rounds, using <code class="highlighter-rouge">divby=3</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">prod</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="p">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">monkey_biz</span><span class="p">(</span><span class="n">monkeys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
    <span class="k">return</span> <span class="n">prod</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="s">"inspected"</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">monkeys</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Part 1: "</span><span class="p">,</span> <span class="n">monkey_biz</span><span class="p">(</span><span class="n">run_monkeys</span><span class="p">(</span><span class="n">read_monkeys</span><span class="p">(</span><span class="s">"input.txt"</span><span class="p">,</span> <span class="n">divby</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">20</span><span class="p">)))</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>The initial version of part1 was very very slow, I never bothered running it for more than 800 rounds. This is because the worries becomes huge. The solution is to apply the modulus product over all monkeys, using the <code class="highlighter-rouge">mod</code> setting in <code class="highlighter-rouge">run_monkeys</code> (I had to consult some forums to get that right).</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mod</span> <span class="o">=</span> <span class="n">prod</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="s">"mod"</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">monkeys</span><span class="p">])</span>
<span class="n">monkeys</span> <span class="o">=</span> <span class="n">run_monkeys</span><span class="p">(</span><span class="n">monkeys</span><span class="o">=</span><span class="n">monkeys</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="n">rounds</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Part 2:"</span><span class="p">,</span> <span class="n">monkey_biz</span><span class="p">(</span><span class="n">monkeys</span><span class="p">))</span>
</code></pre></div>  </div>

</details>

<h2 id="day-12---hill-climbing-algorithm">Day 12 - Hill Climbing Algorithm</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/12">AOC Day 12 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day12.py">code link</a></li>
</ul>

<p>This was easily my favourite entry so far!</p>

<details>
  <summary><i>Click to expand Day12 solution</i><br />&nbsp;<br /></summary>

  <p>The data is a heightfield, with height as char: a(lowest) to z(highest). The path starts at S (height=a), and ends at E (height=z).</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sabqponm
abcryxxl
accszExk
acctuvwj
abdefghi
</code></pre></div>  </div>

  <p>The function <code class="highlighter-rouge">read_map</code> parses the input integer heights (with a=0), extracts the start and end point, and gets the map size m x n. With <code class="highlighter-rouge">make_graph</code> the map is turned into an adjeceny graph, ensuring map bounds are kept and no steps are taken up more than 1 height unit. With this, <code class="highlighter-rouge">bfs</code> is implemented - a vanilla 
<a href="https://en.wikipedia.org/wiki/Breadth-first_search">Breadth First Search</a> to find the shortest path from S to E. I found the <a href="https://docs.python.org/3/library/collections.html#collections.deque">deque</a> being sufficiently fast for both parts.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">collections</span>

<span class="k">def</span> <span class="nf">read_map</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">ord</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()]</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">"S"</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"S"</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">"E"</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"E"</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"z"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># subtract a
</span>    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">make_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">graph</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n</span>
                <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m</span>
                <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span>

<span class="k">def</span> <span class="nf">bfs</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">start</span><span class="p">]</span>
    <span class="n">done</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">}</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="n">deque</span><span class="p">([(</span><span class="n">start</span><span class="p">,</span> <span class="p">[])])</span>
    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">done</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">queue</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="p">]))</span>
            <span class="n">done</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Part one is solved by the following code:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">read_map</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">bfs</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>  </div>

  <p>This is what the solution looks like:</p>

  <figure>
<p><img src="/assets/images/2022/12/01/day12_input_part1.png" alt="Solution ot part 1." id="figure-1" width="95%" /></p>
  <figcaption>Figure 1: Solution to part 1.</figcaption>
</figure>

  <p>The figure was made using matplotlib</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># data from read_map, sol from bfs
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">],</span> <span class="s">"r-"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s">"m*"</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s">"b+"</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>In part 2, any point at height <code class="highlighter-rouge">a</code> is used as the starting point.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">read_map</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">graph</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">bfs</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sol</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">best</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">best</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>  </div>

</details>

<p>This is what the solution looks like:</p>

<figure>
<p><img src="/assets/images/2022-12-01/day12_input_part2.png" alt="Solution ot part 2." id="figure-2" width="95%" /></p>
  <figcaption>Figure 2: Part 2: The yellow path is the shortest path, the red are candidates.</figcaption>
</figure>

<h2 id="day-13---distress-signal">Day 13 - Distress Signal</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/13">AOC Day 13 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day13.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day13 solution</i><br />&nbsp;<br /></summary>

  <p>Data are pairs of nested lists separated by blanks</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1,1,3,1,1]
[1,1,5,1,1]

[[1],[2,3,4]]
[[1],4]
</code></pre></div>  </div>

  <p>This data is parsed to python lists in <code class="highlighter-rouge">read_pairs</code>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_pairs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">eval</span><span class="p">,</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">]</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong></p>

  <p>Task: compare pairs, and print the sum of indices of the pairs that are in order, as done in <code class="highlighter-rouge">part1</code>.</p>

  <p>The comparison is done in <code class="highlighter-rouge">compare</code>. If anything is found in or out of order the comparison stops and returns the results. Pairs of <code class="highlighter-rouge">int</code> are in order if <code class="highlighter-rouge">left &lt; right</code> and out of order <code class="highlighter-rouge">right &lt; left</code>. List pairs are iterated over sequentially, integer items are compared like above, and the procedure is recursed for list items. Mixed pairs are comnverted to list pairs. If the left list still has items remaining the pair is ìn order, and if the right list still has items remaining it is out of order.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="n">ints</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ints</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">return</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">r</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compare</span><span class="p">([</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">if</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">part1</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">compare</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div>  </div>

  <p><strong>Part 2</strong></p>

  <p>Task: flatten pairs, add items <code class="highlighter-rouge">[[2]]</code> and <code class="highlighter-rouge">[[6]]</code>, sort according to <code class="highlighter-rouge">compare</code>, and find the product of indices of <code class="highlighter-rouge">[[2]]</code> and <code class="highlighter-rouge">[[6]]</code>.</p>

  <p>Here I use <a href="https://docs.python.org/3/library/functools.html#functools.cmp_to_key"><code class="highlighter-rouge">functools.cmp_to_key</code></a> to turn <code class="highlighter-rouge">compare</code> into a  <a href="https://docs.python.org/3/glossary.html#term-key-function">key function</a>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="k">def</span> <span class="nf">prod</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">functools</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="p">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="p">[[[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">6</span><span class="p">]]],</span>
        <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="p">.</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="k">lambda</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="o">-</span><span class="n">compare</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">prod</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">([[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">6</span><span class="p">]])])</span>
</code></pre></div>  </div>

  <p>Somehow my comparator only works in negative, but it does work :)</p>

</details>

<h2 id="day-14---regolith-reservoir">Day 14 - Regolith Reservoir</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/14">AOC Day 14 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day14.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day14 solution</i><br />&nbsp;<br /></summary>

  <p>Data represents a map with obstacles givens as vertical or horizontal line segments:</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>498,4 -&gt; 498,6 -&gt; 496,6
503,4 -&gt; 502,4 -&gt; 502,9 -&gt; 494,9
</code></pre></div>  </div>

  <p>In <code class="highlighter-rouge">read_map</code> this data is read in and transformed into a list of lines, each consisting of list of segments.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_map</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"-&gt;"</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="p">]</span>
</code></pre></div>  </div>

  <p>This can easily by plotted with matplotlib as a <a href="https://matplotlib.org/stable/api/collections_api.html#matplotlib.collections.LineCollection">LineCollection</a></p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">LineCollection</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">autoscale_view</span><span class="p">()</span>  <span class="c1"># See comment above, after ax1.add_collection.
</span>    <span class="n">ax</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="n">ax</span><span class="p">.</span><span class="n">get_ylim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">'equal'</span><span class="p">,</span> <span class="s">'box'</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">indata</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>  </div>

  <figure>
<p><img src="/assets/images/2022/12/01/day14_map.png" alt="Map from input data." id="figure-1" width="241px" /></p>
  <figcaption>Figure 1: Map from input data.</figcaption>
</figure>

  <p>For the sand simulation it will be more convenient knowing which positions (pixels) are occupied.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_pixles</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">pxl</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">segs</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">segs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">segs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">pxl</span><span class="p">.</span><span class="n">update</span><span class="p">({((</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span> <span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">si</span><span class="p">,</span> <span class="n">si</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">pxl</span>

<span class="k">def</span> <span class="nf">limits</span><span class="p">(</span><span class="n">pixels</span><span class="p">):</span>
    <span class="p">(</span><span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="p">),(</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pxl</span><span class="p">))</span>    
    <span class="k">return</span> <span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="p">,</span> <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span>

</code></pre></div>  </div>

  <p>At (500,0) sand grains are produced and fall one at a time until they come to rest. Grains try to fall down, if down is blocked they go down-left, if that also is blocked down-right, and if everything is blocked it stops.</p>

  <p><strong>Tasks</strong></p>

  <p>Part1: How many sand grains come to rest before sand starts flowing into the abyss below?</p>

  <p>Part2: How many sand grains come to rest before sand hole gets filled, assuming an infinite floor at max(mapy)+2</p>

  <p>As sand propgagation is the same, really the only thing tat is different between the parts is the bounds checking. I solve that by adding missing floor pixels for part2.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add_sand</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="p">,</span> <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="n">part1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">((</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pixels</span>
            <span class="p">),</span>
            <span class="bp">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">if</span> <span class="n">part1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max1</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min0</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max0</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">max1</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">pixels</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="bp">True</span>                
            <span class="k">continue</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">part1</span><span class="p">):</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">make_pixles</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="p">,</span> <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span> <span class="o">=</span> <span class="n">limits</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">add_sand</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="p">,</span> <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="n">part1</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">==</span><span class="mi">2</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>

</code></pre></div>  </div>

  <p>To pretty print the map I added</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">print_pixels</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="s">"."</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="s">"#"</span><span class="p">,</span> <span class="n">sand</span><span class="o">=</span><span class="s">"o"</span><span class="p">):</span>
    <span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="p">,</span> <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span> <span class="o">=</span> <span class="n">limits</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">((</span><span class="n">blank</span><span class="p">,</span> <span class="n">full</span><span class="p">,</span> <span class="n">sand</span><span class="p">)[</span><span class="n">pixels</span><span class="p">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="bp">False</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min0</span><span class="p">,</span> <span class="n">max0</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

<span class="n">print_pixels</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="s">"⬜"</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="s">"🟫"</span><span class="p">,</span> <span class="n">sand</span><span class="o">=</span><span class="s">"🟨"</span><span class="p">)</span>
</code></pre></div>  </div>

  <p>which gives this output for part 2 (using fancy box characters):</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜🟨⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜
⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜🟨🟨🟨⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜
⬜⬜⬜⬜⬜⬜⬜⬜⬜🟨🟨🟨🟨🟨⬜⬜⬜⬜⬜⬜⬜⬜⬜
⬜⬜⬜⬜⬜⬜⬜⬜🟨🟨🟨🟨🟨🟨🟨⬜⬜⬜⬜⬜⬜⬜⬜
⬜⬜⬜⬜⬜⬜⬜🟨🟨🟫🟨🟨🟨🟫🟫🟨⬜⬜⬜⬜⬜⬜⬜
⬜⬜⬜⬜⬜⬜🟨🟨🟨🟫🟨🟨🟨🟫🟨🟨🟨⬜⬜⬜⬜⬜⬜
⬜⬜⬜⬜⬜🟨🟨🟫🟫🟫🟨🟨🟨🟫🟨🟨🟨🟨⬜⬜⬜⬜⬜
⬜⬜⬜⬜🟨🟨🟨🟨⬜🟨🟨🟨🟨🟫🟨🟨🟨🟨🟨⬜⬜⬜⬜
⬜⬜⬜🟨🟨🟨🟨🟨🟨🟨🟨🟨🟨🟫🟨🟨🟨🟨🟨🟨⬜⬜⬜
⬜⬜🟨🟨🟨🟫🟫🟫🟫🟫🟫🟫🟫🟫🟨🟨🟨🟨🟨🟨🟨⬜⬜
⬜🟨🟨🟨🟨🟨⬜⬜⬜⬜⬜⬜⬜🟨🟨🟨🟨🟨🟨🟨🟨🟨⬜
🟫🟫🟫🟫🟫🟫🟫⬜⬜⬜⬜⬜🟫🟫🟫🟫🟫🟫🟫🟫🟫🟫🟫
</code></pre></div>  </div>

</details>

<h2 id="day-15---beacon-exclusion-zone">Day 15 - Beacon Exclusion Zone</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/15">AOC Day 15 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day15.py">code link</a></li>
</ul>

<details>
  <summary><i>Click to expand Day15 solution</i><br />&nbsp;<br /></summary>

  <p>Data is on this form:</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sensor at x=2, y=18: closest beacon is at x=-2, y=15
Sensor at x=9, y=16: closest beacon is at x=10, y=16
...
</code></pre></div>  </div>

  <p>For the solution I need the manhattan distance between sensor and closest beacon. So I read in the data, parse as ints and compute the distance:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">read_beacons</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">distance</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
                <span class="p">(</span>
                    <span class="nb">tuple</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"; |, |=|:"</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">i</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">isdigit</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>  </div>

  <p><strong>Part 1</strong>:</p>

  <p>Task: Count positions that are covered between the beacons and sensors for row 2000000</p>

  <p>To solve this I fill all covered positions, taking care to remove Beacons from the count</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cover</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">beacons</span><span class="p">):</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">beacons</span><span class="p">:</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">overlap</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dd</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">overlap</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered</span><span class="p">)</span>
</code></pre></div>  </div>

  <p><strong>Part2</strong></p>

  <p>Now it asked to search for a single gap in coverage over the range (0, lim) in both x and y. I tried using the original cover function for this, but I only reached 6 rows / second. and with 4000000, I didn’t feel like waiting that long.</p>

  <p>Instead, I keep track of the covered ranges [(x0, x1), … ] for a row at a time. When adding a beacon, I make sure to merge any overlapping coverages.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_covers</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">beacons</span><span class="p">,</span> <span class="n">lim</span><span class="p">):</span>
    <span class="n">covers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">beacons</span><span class="p">:</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dd</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">covers</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Now remove covers
</span>        <span class="n">covers</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">covers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">covers</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">covers</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">covers</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">covers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">covers</span> <span class="o">=</span> <span class="n">covers</span><span class="p">[:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">covers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">covers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">lim</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">covers</span>
    <span class="k">return</span> <span class="n">covers</span>
</code></pre></div>  </div>

  <p>Now part2 is solved:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">part2</span><span class="p">(</span><span class="n">lim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beacons</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">):</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">calc_covers</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">beacons</span><span class="p">,</span> <span class="n">lim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">4000000</span> <span class="o">*</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span>
</code></pre></div>  </div>

  <p>This takes about 30s instead of something like 200h…
I feel like I could have used an <a href="https://en.wikipedia.org/wiki/Interval_tree">Interval Tree</a> but my simple approach worked sufficiently fast for the problem at hand.</p>

</details>

<h2 id="day-16---proboscidea-volcanium">Day 16 - Proboscidea Volcanium</h2>

<ul>
  <li><a href="https://adventofcode.com/2022/day/16">AOC Day 16 link</a></li>
  <li><a href="https://github.com/thomasburgess/advent2022/blob/main/day16.py">code link</a></li>
</ul>

<p>I really struggled with part2 of this problem…</p>

<details>
  <summary><i>Click to expand Day16 solution</i><br />&nbsp;<br /></summary>

  <p>The data is a maze of tunnels with valves that has a flow rate in units/minute.</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Valve AA has flow rate=0; tunnels lead to valves DD, II, BB
Valve BB has flow rate=13; tunnels lead to valves CC, AA
</code></pre></div>  </div>

  <p>This is nice to parse with <a href="https://docs.python.org/3/library/re.html#functions"><code class="highlighter-rouge">re.split</code></a> as follows.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>

<span class="n">VALVES_T</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span> <span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span>
<span class="k">def</span> <span class="nf">read_valves</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VALVES_T</span><span class="p">:</span>
    <span class="n">valves</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">v</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"rate=|; "</span><span class="p">,</span> <span class="n">v</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">re</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"valves|valve"</span><span class="p">,</span> <span class="n">v</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">split</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>  </div>
  <p>(later I realized this could be achived with a single split… but this works just fine as is).</p>

  <p><strong>Task 1</strong></p>

  <p>An explorer starts at valve <code class="highlighter-rouge">AA</code>, can walk for 1 minute through a tunnel, or open a valve for 1 minute. All valves start closed. What is the highest output throught the valves that can be achieved in 30 mins.</p>

  <p>These possibilities are encoded in <code class="highlighter-rouge">generate_steps</code>:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span><span class="n">valves</span><span class="p">:</span> <span class="n">VALVES_T</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">opened</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">])]:</span>
    <span class="c1"># Explore tunnels
</span>    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valves</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">yield</span> <span class="n">v</span><span class="p">,</span> <span class="n">opened</span>
    <span class="c1"># Open valve
</span>    <span class="k">if</span> <span class="n">valves</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opened</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">c</span><span class="p">,</span> <span class="n">opened</span> <span class="o">|</span> <span class="nb">set</span><span class="p">((</span><span class="n">c</span><span class="p">,))</span>
</code></pre></div>  </div>

  <p>with which the tunnels can be explored using <code class="highlighter-rouge">search</code>:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">search</span><span class="p">(</span>
    <span class="n">valves</span><span class="p">:</span> <span class="n">VALVES_T</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">opened</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">search_type</span><span class="p">:</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="n">deque</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opened</span><span class="p">)])</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">opened</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">paths</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">pressure</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">opened</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">seen</span><span class="p">.</span><span class="n">get</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pressure</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">seen</span><span class="p">[(</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pressure</span>
        <span class="n">pressure</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">valves</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opened</span><span class="p">)</span>
        <span class="n">queue</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pressure</span> <span class="o">+</span> <span class="p">(</span><span class="n">valves</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">generate_steps</span><span class="p">(</span><span class="n">valves</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">opened</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">paths</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>  </div>

  <p>This works and givesd a result in less than a second.</p>

  <p><strong>Task 2</strong></p>

  <p>I spent a lot of time trying to adapt <code class="highlighter-rouge">search</code> for reusue, but I kept getting the wrong answer. At the end of the day i resorted to nested for loops. This was crazy slow for the input data set though. Frustrated enough, I picked up a quick and dirty pruning trick from <a href="https://vis.social/@llimllib">llimllib</a>.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">search_elephant</span><span class="p">(</span><span class="n">valves</span><span class="p">:</span> <span class="n">VALVES_T</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"AA"</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">frontier</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span> <span class="nb">set</span><span class="p">())]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># it _works_ with my data...
</span>            <span class="c1"># A priority queue would have been a little nicer
</span>            <span class="n">frontier</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">frontier</span> <span class="o">=</span> <span class="n">frontier</span><span class="p">[:</span><span class="mi">5000</span><span class="p">]</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pressure</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">opened</span> <span class="ow">in</span> <span class="n">frontier</span><span class="p">:</span>
            <span class="n">pressure</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">valves</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opened</span><span class="p">)</span>
            <span class="n">update</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">ib</span><span class="p">),</span> <span class="n">ob</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">oa</span> <span class="ow">in</span> <span class="n">generate_steps</span><span class="p">(</span><span class="n">valves</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">opened</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ob</span> <span class="ow">in</span> <span class="n">generate_steps</span><span class="p">(</span><span class="n">valves</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">oa</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">frontier</span> <span class="o">=</span> <span class="n">update</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">frontier</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>  </div>

</details>

<h2 id="the-rest-of-the-days">The rest of the days</h2>

<p>I did not have the time to go on this year, maybe I will have better luck next year.</p>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2022/12/01/aoc22.html</link>
			<category>posts</category>
		    <category>advent</category><category>coding</category><category>python</category><media:title type="html"><![CDATA[Advent of Code 2022 ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2022/12/01/aoc2022.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2022/12/01/aoc2022.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2022/12/01/aoc22.html</guid>
      <pubDate>Thu, 01 Dec 2022 00:00:00 +0100</pubDate>
		</item><item>
			<title>Fun with fish tiles</title>
			<description>
				<![CDATA[	
 				
    		<p>1 min.</p>
				<div><p>This article was featured in Mitteiling der Meutschen Mathematiker-Vereingung<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>.</p>

<h2 id="the-fish-tile">The fish tile</h2>

<p>A fish tile is shown in <a href="#figure-1">Figure 1.</a> It is remarkably fun to play with! It is formed by two equilateral pentagons - the regular pentagon head, and the pentagonal crescent tail. The tail opening angle is 108 degrees so it fits a regular pentagon, while the angle between the head and tail is 144 degrees and fits a regular decagon.</p>

<figure>
<p><img src="/assets/images/2022/10/15/fish.png" alt="The fish tile - a regular pentagon joined with the base of a pentagonal crescent." id="figure-1" width="200px" /></p>
  <figcaption>Figure 1: The fish tile.</figcaption>
</figure>

<p>All of the images in this post were made using the excellent <a href="https://apps.apple.com/us/app/girih-polygon-pattern-design/id1400485589?mt=12">Girih App</a>. For the Escher like cartoon on top, I added fish faces in Affinity designer, and for the big tiling at the end I used Affinity photo to add a background gradient, a signature and some drop shadow.</p>

<h2 id="fish-rings">Fish rings</h2>

<p>Two regular pentarings of five fish are shown in <a href="#figure-2">Figure 2.</a> 
In the first one, heads connect to the side of the tail forming a central star, and in the second one, heads go inside the tail to form a pentagon. I think these are the only possible pentarings of fish.</p>

<figure>
<p><img src="/assets/images/2022/10/15/5_fish.png" alt="Pentarings - regular rings of two fish tiles." id="figure-2" width="600px" /></p>
  <figcaption>Figure 2: Pentarings.</figcaption>
</figure>

<p>Similarly, there are decarings, shown in <a href="#figure-3">Figure 3.</a>. 
First a decagon formed by tiling heads in 5.5.10 vertices, next a star is formed by putting heads together, and finally a large pentagon is formed by flipping the heads in the star tiling.</p>

<figure>
<p><img src="/assets/images/2022/10/15/10_fish.png" alt="Decarings - regular rings of ten fish tiles." id="figure-3" width="800px" /></p>
  <figcaption>Figure 3: Decarings.</figcaption>
</figure>

<h2 id="tiling-the-plane">Tiling the plane</h2>

<p>By making concentric pentarings, all of the plane except the central pengagon can be tiled, as shown in <a href="#figure-4">Figure 4.</a>. However, by tiling fishes head to tail on straight lines tilings over the full plane can be achived. Lines fit together regardless of swimming direction, as shown in the two examples pineapple fish examples shown in <a href="#figure-5">Figure 5.</a> The second tiling, is identical to the one used in the cartoon header of this blog post.</p>

<figure>
<p><img src="/assets/images/2022/10/15/ring_plane.png" alt="Rings on a plane - concentric pentaring pineapple tiling." id="figure-4" width="300px" /></p>
  <figcaption>Figure 4: Rings on a plane.</figcaption>
</figure>

<figure>
<p><img src="/assets/images/2022/10/15/planes.png" alt="Tiling the plane with pineapples." id="figure-5" width="800px" /></p>
  <figcaption>Figure 5: Tiling the plane with pineapples.</figcaption>
</figure>

<h2 id="big-tiling">Big tiling</h2>

<p>Finally, in <a href="#figure-6">Figure 6.</a>, is a tiling (with holes) using the pentaring from <a href="#figure-1">Figure 1.</a>. In addition to the pentagonal holes, this tiling has squiggly rhombic holes, with pointy angles 1/10 of a full turn.</p>

<figure>
<p><img src="/assets/images/2022/10/15/fishdish.png" alt="Big pentaring tiling." id="figure-3" width="800px" /></p>
  <figcaption>Figure 6: Big pentaring tiling.</figcaption>
</figure>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Burgess, T. (2024). Fun with fish tiles. Mitteilungen der Deutschen Mathematiker-Vereinigung, 32(3), 170-171. <a href="https://doi.org/10.1515/dmvm-2024-0053">https://doi.org/10.1515/dmvm-2024-0053</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2022/10/15/Fish-tiles.html</link>
			<category>posts</category>
		    <category>geometry</category><category>math</category><category>mathart</category><category>n-gons</category><category>tiling</category><media:title type="html"><![CDATA[Fun with fish tiles ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2022/10/15/header_crop.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2022/10/15/header_crop.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2022/10/15/Fish-tiles.html</guid>
      <pubDate>Sat, 15 Oct 2022 00:00:00 +0200</pubDate>
		</item><item>
			<title>Parameter space</title>
			<description>
				<![CDATA[	
 				<h3><p>Parallel iteration over a parameter space</p>
</h3>
    		<p>2 min.</p>
				<div><p><em>Header image credit</em><sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></p>

<h2 id="introduction">Introduction</h2>

<p>I often find myself having to run code for some arbitrary set of different parameters.
This can be done with nested <code class="highlighter-rouge">for</code> loops. This is not pretty, and poses a challenge for paralleization and progress tracking. In this blog post, I solve this in python with <a href="https://tqdm.github.io">tqdm</a> for progress bars and <a href="https://github.com/uqfoundation/multiprocess">multiprocess</a> for parallelizing.</p>

<h2 id="weather-example">Weather example</h2>

<p>Assume we want to evaluate a model <code class="highlighter-rouge">p_rain(rained, temp)</code> that estimates probability of rain tomorrow given the current weather condition over the following parameter space:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="s">"temp"</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">)}</span>
</code></pre></div></div>

<p>A basic attempt with nested for loops:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rained</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s">"rained"</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s">"temp"</span><span class="p">]:</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">p_rain</span><span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">)))</span>
</code></pre></div></div>
<p>Note how more paramters makes loop nesting deeper!</p>

<p>With <code class="highlighter-rouge">tqdm</code> a progress indicator is added:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rained</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s">"rained"</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s">"temp"</span><span class="p">]:</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">p_rain</span><span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">)))</span>
</code></pre></div></div>
<p>However, it will only update on 0, 50, and 100% steps as there are only 2 values of <code class="highlighter-rouge">rained</code>. Moving <code class="highlighter-rouge">tqdm</code> to the inner loop will give 2 fast progress bars instead one slow one. Neither is good, and the order of loops can make a big difference.</p>

<p>Next, adding some parallelization with <code class="highlighter-rouge">multiprocess.Pool.map</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocess</span><span class="p">.</span><span class="n">Pool</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rained</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s">"rained"</span><span class="p">]):</span>
    <span class="n">result</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="n">pool</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">temp</span><span class="p">:</span>
            <span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">p_rain</span><span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">)),</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s">"temp"</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>
<p>The parallelization now has a bottleneck in waiting for the outer loop. And to an even larger extent, the ordering of loops matter. While this setup can work, it is easy to do better!</p>

<p>What is needed, is a flat list of all parameters, that some function that achieves this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">flat_dicts</span><span class="p">({</span><span class="s">"rained"</span><span class="p">:</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="s">"temp"</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">)})</span>
<span class="p">[{</span><span class="s">"rained"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">"temp"</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
 <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">"temp"</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
 <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">"temp"</span><span class="p">:</span> <span class="mi">25</span><span class="p">},</span>
 <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"temp"</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
 <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"temp"</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
 <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"temp"</span><span class="p">:</span> <span class="mi">25</span><span class="p">}]</span>
</code></pre></div></div>
<p>With this the above loops can be reduced to a single loop, and tqdm and pool can work as expected.</p>

<h2 id="cartesian-product">Cartesian product</h2>

<p>With <a href="https://docs.python.org/3/library/itertools.html?highlight=itertools%20product#itertools.product">itertools.product</a> all combinations can easily be generated:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">)))</span>
<span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</code></pre></div></div>

<p>In the rain example dictionary, make the product on parameter values, then loop over each parameter tuple and add keys:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">flat_lists</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">i</span><span class="p">)}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">flat_dicts</span><span class="p">({</span><span class="s">"rained"</span><span class="p">:</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="s">"temp"</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">)}))</span>
<span class="p">[{</span><span class="s">'rained'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
<span class="p">{</span><span class="s">'rained'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
<span class="p">{</span><span class="s">'rained'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">:</span> <span class="mi">25</span><span class="p">},</span>
<span class="p">{</span><span class="s">'rained'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
<span class="p">{</span><span class="s">'rained'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
<span class="p">{</span><span class="s">'rained'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">:</span> <span class="mi">25</span><span class="p">}]</span>
</code></pre></div></div>
<p>wich is exactly what we hoped to achieve.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>First define a product function and a looper</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">multiprocess</span> <span class="k">as</span> <span class="n">mp</span>

<span class="k">def</span> <span class="nf">loop_pars</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flat_dicts</span><span class="p">(</span><span class="n">pars</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pool</span><span class="p">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">x</span><span class="p">,</span> <span class="s">"result"</span><span class="p">:</span> <span class="n">fun</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)},</span> <span class="n">tasks</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</code></pre></div></div>
<p>To get this working, <code class="highlighter-rouge">tqdm</code> must know the total iteration count, and use <code class="highlighter-rouge">imap</code> to get data once it’s finished.</p>

<p>And now we can run a simple test (with a terribly inaccurate logistic weather model):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">p_rain</span><span class="p">(</span><span class="n">rained</span><span class="p">,</span> <span class="n">temp</span><span class="p">):</span> 
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">temp</span><span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">rained</span><span class="p">))))</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">"rained"</span><span class="p">:</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="s">"temp"</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
<span class="k">with</span> <span class="n">mp</span><span class="p">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">loop_pars</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">p_rain</span><span class="p">,</span> <span class="n">pool</span><span class="p">))</span>
<span class="n">df</span>
</code></pre></div></div>
<p>Here, execution was slowed down by limiting to 2 processes and sleeping. The result 
running in a <a href="https://jupyter.org">jupyter notebook</a> using <a href="https://tqdm.github.io/docs/notebook/">tqdm.notebook</a>.:</p>

<figure>
<p><img src="/assets/images/2022/05/31/parallel.gif" alt="Parallel execution with progress bar." id="figure-1" width="80%" /></p>
  <figcaption>Figure 1: Parallel execution with progress bar.</figcaption>
</figure>

<h2 id="summary">Summary</h2>

<p>Using a the cartesian product allows flattening an otherwise deeply nested loop. Not only does this make code prettier, but also easier to parallelize.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Jupiter (2019) NASA, ESA, A. Simon (Goddard Space Flight Center), and M.H. Wong (University of California, Berkeley)_ <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2022/05/31/Parameter-Space.html</link>
			<category>posts</category>
		    <category>blog</category><category>coding</category><category>python</category><media:title type="html"><![CDATA[Parameter space ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2022/05/31/jupiter.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2022/05/31/jupiter.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2022/05/31/Parameter-Space.html</guid>
      <pubDate>Tue, 31 May 2022 00:00:00 +0200</pubDate>
		</item><item>
			<title>Polygon vertices</title>
			<description>
				<![CDATA[	
 				<h3><p>All the ways regular polygons tile the plane</p>
</h3>
    		<p>7 min.</p>
				<div><h2 id="introduction">Introduction</h2>

<p>There are only 21 ways to place regular polygons in gapless tilings. The point where the polygons meet is called a vertex. Vertices are named by the polygons meeting there. For instance, the vertex where four squares meet is 4.4.4.4. In this post, I will make code to find and draw all possible vertices.</p>

<h2 id="regular-polygons">Regular polygons</h2>

<p>A regular polygon has \(n\) sides. The <em>interior</em> angle \(\alpha\) between two adjacent sides is 
\begin{equation}
\alpha=\frac{n-2}{2n}.
\end{equation}
The turning angle \(\beta=1/n\) of a polygon is the angle to the centre between two adjacent points.
For simplicity, I write angles as fractions of a complete turn. Multiply by \(2\pi\) or \(360^\circ\) to get radians or degrees.</p>

<figure>
<p><img src="/assets/images/2022/04/17/angles.svg" alt="Angles in a regular polygon." id="figure-1" width="25%" /></p>
  <figcaption>Figure 1: Angles in a regular polygon.</figcaption>
</figure>

<p>The pointiest polygon is the regular triangle with \(\alpha=1/6\). When increasing \(n\), 
\(\alpha\) increases towards \(1/2\).</p>

<h2 id="searching-for-vertices">Searching for vertices</h2>

<p>For a tiling to be gapless, the sum of interior angles \(\alpha\) at a vertex must be 1. 
Thus, the complete set of vertices can be found by finding all sets \(v_i\) so that:
\begin{equation}
\sum_{n_j\in v_i} \frac{n_j-2}{2n_j} = 1\,.
\end{equation}</p>

<p>Before searching, it helps to have ranges on the possible number of polygons \(m\) and 
sides \(n\) in \(v_i\).  The count \(m\) must be larger than 2, as no two regular polygons can
add up to 1. Furthermore, the highest \(m\) is six as 3.3.3.3.3.3 as 
\(\sum_{n \in 3.3.3.3.3.3} \alpha=6\cdot1/6=1\). For \(m=6\) this is the only possible 
vertex.</p>

<p>For \(m=3\), the two shape combination leaving the smallest angle \(\alpha\lt1/2\) is 3 
and 7, as that 3 and 6 leaves exactly \(\alpha=1/2\), which can’t be a polygon. The 
remaining angle then is</p>

<p>\begin{equation}
\alpha=1-\left(\alpha_3+\alpha_2\right)=
1-\left(\frac{3-2}{2\cdot3}+
\frac{7-2}{2\cdot7}\right)=
\frac{10}{21}\,,
\end{equation}
and with \((n-2)/(2n)=10/21\) we get \(n=42\). Similarly for \(m=4\), 3.3.4 leaves 
\(\alpha\le1-(2/6+2/8)=5/12\), corresponding to \(n=12\). Finally for \(m=5\), 3.3.3.3 
leaves \(\alpha\le1-(4/6)=1/3\), corresponding to \(n_5=6\).</p>

<p>In summary:</p>

<p>\[
m:3 \quad 3\le n\le 42 <br />
\]
\[
m:4 \quad 3\le n\le 12 <br />
\]
\[
m:5 \quad 3\le n\le 6 <br />
\]
\[
m:6 \quad n=3 
\]</p>

<p>All possible vertices are found by searching for combinations of \(m\) elements with 
\(n\) inside the constrained range. Note that this brute force approach will trivial 
clones of vertices in the form of rotations and mirror images. Moreover, there are some 
cases of different vertices with the same polygon content. Thus, I first generate 
(sorted) combinations with replacements of polygons for each \(m\). If a set sums to 1, 
I yield permutations not already stored as a mirror or rotation.</p>

<h2 id="python-search-implementation">Python search implementation</h2>

<p>For the search I only rely on python 3.8+ and its built in libraries. You don’t need 
to read the code unless you’re interested in the deeper details of how I find vertices. 
There are likely more efficient solutions, but I think this works good enough for me :)</p>

<details>
  <summary><i>Click to expand the python code...</i><br />&nbsp;<br /></summary>

  <p>Imports:</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span><span class="p">,</span> <span class="n">permutations</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span> <span class="k">as</span> <span class="n">F</span>
</code></pre></div>  </div>

  <p>Constraints</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Range of polygon count at vertex
</span><span class="n">m_min</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">m_max</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1"># Range of n-gon n at vertex
</span><span class="n">n_min</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">n_max</span> <span class="o">=</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</code></pre></div>  </div>
  <p>Fucntions</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">n_gon</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="p">:</span>
    <span class="s">"""Make n-gon interior angle as fraction of full turn"""</span>
    <span class="k">return</span> <span class="n">F</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">rotrev</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="s">"""Generate all rotations and mirrors of s"""</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        
<span class="k">def</span> <span class="nf">find_vertices</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="s">"""Find vertices"""</span>
    <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over number of n-gons
</span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m_min</span><span class="p">,</span> <span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
        <span class="c1"># Loop over all possible vertex candidates
</span>        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m_min</span><span class="p">,</span> <span class="n">n_max</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="n">n_min</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">r</span><span class="o">=</span><span class="n">m</span><span class="p">):</span>            
            <span class="c1"># Only consider proper vertices
</span>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n_gon</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Add permutations 
</span>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">comb</span><span class="p">):</span>
                <span class="c1"># Reject rotated or reversed forms
</span>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">d</span> <span class="ow">in</span> <span class="n">found</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rotrev</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                    <span class="k">continue</span>
                <span class="n">found</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">found</span>
</code></pre></div>  </div>

  <p>Running the search takes less than a seconds on my laptop</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vertices</span> <span class="o">=</span> <span class="n">find_vertices</span><span class="p">()</span>
</code></pre></div>  </div>

</details>

<h2 id="search-result">Search result</h2>

<p>This table was made processing the resulting vertex list. Here \(m\) still is the
number of polygons, each integer column the counts for a particular shape, and \(u\) 
the number of unique shapes.</p>

<table>
  <thead>
    <tr>
      <th>vertex</th>
      <th>\(m\)</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>12</th>
      <th>15</th>
      <th>18</th>
      <th>20</th>
      <th>24</th>
      <th>42</th>
      <th>\(u\)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>3.7.42</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.8.24</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.9.18</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.10.15</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.12.12</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>4.5.20</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4.6.12</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4.8.8</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>5.5.10</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>6.6.6</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>3.3.4.12</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.4.3.12</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.3.6.6</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3.6.3.6</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3.4.4.6</td>
      <td>4</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>3.4.6.4</td>
      <td>4</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4.4.4.4</td>
      <td>4</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>3.3.3.3.6</td>
      <td>5</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3.3.3.4.4</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3.3.4.3.4</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3.3.3.3.3.3</td>
      <td>6</td>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>total</td>
      <td>-</td>
      <td>15</td>
      <td>10</td>
      <td>2</td>
      <td>7</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>-</td>
    </tr>
  </tbody>
</table>

<p>Noteworthy observations</p>
<ul>
  <li>There are a total of 21 vertices (10 \(m=3\), 7 \(m=4\), 3 \(m=5\), 1 \(m=6\))</li>
  <li>There are 1-3 polygon types in a vertex (10 \(u=3\), 8 \(u=2\), 3 \(u=1\))</li>
  <li>The three single polygon type vertices are triangles, squares, and hexagons - the only three ways to tile the plane with a single polygon type!</li>
  <li>Only 3-, 4-, 5-, 6-, 8-, 10- and 12-gons occur in more than one vertex
    <ul>
      <li>5 and 10 only ever occurr together</li>
      <li>15 vertices contains triangles, 10 squares, 7 hexagons, and 4 dodecagons</li>
    </ul>
  </li>
</ul>

<p>Below is the code I used to generate the table and insights</p>

<details>
  <summary><i>Click to expand the python code...</i><br />&nbsp;<br /></summary>

  <p>Imports (in addition to above code)</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
</code></pre></div>  </div>

  <p>Functions</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">vertex_str</span><span class="p">(</span><span class="n">vtx</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""Make vertex notation from ints."""</span>
    <span class="k">return</span> <span class="s">'.'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">vtx</span><span class="p">))</span>    

<span class="k">def</span> <span class="nf">make_df</span><span class="p">(</span><span class="n">vertices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s">"""Make data frame with vertex summary."""</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">find_vertices</span><span class="p">()</span>
    <span class="n">ngons</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">vertices</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">"m"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s">"vertex"</span><span class="p">:</span> <span class="n">f</span><span class="p">}</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ngon</span> <span class="ow">in</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">vertices</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">}:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">ngon</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"vertex"</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">count</span><span class="p">(</span><span class="n">ngon</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"vertex"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"vertex"</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="n">vertex_str</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">"vertex"</span><span class="p">)[[</span><span class="s">"m"</span><span class="p">]</span><span class="o">+</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ngons</span><span class="p">))]</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"u"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ngons</span><span class="p">)]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">).</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"n_vertices"</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>  </div>

  <p>Running</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="o">=</span><span class="n">make_df</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">"m"</span><span class="p">].</span><span class="n">value_counts</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">"u"</span><span class="p">].</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre></div>  </div>

</details>

<h2 id="drawing-vertices">Drawing vertices</h2>

<p>To draw vertices correctly, I define a polygon by \(n\) and one side.
Swapping the side start and end points mirrors the polygon.</p>

<details>
  <summary><i>Click to expand the python code...</i><br />&nbsp;<br /></summary>

  <p>Imports</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="n">mpatches</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">PatchCollection</span>
</code></pre></div>  </div>

  <p>Functions</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_patch</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s">"white"</span><span class="p">):</span>
    <span class="s">"""Helper to draw polygon patch to ax"""</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">add_collection</span><span class="p">(</span>
         <span class="n">PatchCollection</span><span class="p">([</span><span class="n">mpatches</span><span class="p">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">points</span><span class="p">)],</span> <span class="n">fc</span><span class="o">=</span><span class="n">fc</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s">'k'</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    
<span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s">"""
    Args:
        * n (int) - n in n-gon
        * line (np.array) - ((x0,y0), (x1,y1)) line segment
    Returns:
        np.ndarray: shape (n, 2) x,y coordinate pairs
        
    """</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">diff</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>
        <span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">n_gon</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span><span class="o">+</span>\
        <span class="n">np</span><span class="p">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">hstack</span><span class="p">(((</span><span class="n">p</span><span class="o">+</span><span class="n">np</span><span class="p">.</span><span class="n">cumsum</span><span class="p">(</span>
        <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)]),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">p</span><span class="p">)).</span><span class="n">T</span>
</code></pre></div>  </div>

  <p>Colors</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">"royalblue"</span><span class="p">,</span> 
    <span class="mi">4</span><span class="p">:</span> <span class="s">"orangered"</span><span class="p">,</span> 
    <span class="mi">5</span><span class="p">:</span> <span class="s">"hotpink"</span><span class="p">,</span> 
    <span class="mi">6</span><span class="p">:</span> <span class="s">"gold"</span><span class="p">,</span> 
    <span class="mi">7</span><span class="p">:</span> <span class="s">"magenta"</span><span class="p">,</span> 
    <span class="mi">8</span><span class="p">:</span> <span class="s">"darkorange"</span><span class="p">,</span> 
    <span class="mi">9</span><span class="p">:</span> <span class="s">"yellowgreen"</span><span class="p">,</span> 
    <span class="mi">10</span><span class="p">:</span> <span class="s">"lightsteelblue"</span><span class="p">,</span> 
    <span class="mi">12</span><span class="p">:</span> <span class="s">"limegreen"</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s">"lightcoral"</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">"khaki"</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s">"orchid"</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s">"plum"</span><span class="p">,</span>
    <span class="mi">42</span><span class="p">:</span> <span class="s">"palegreen"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <p>Running</p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># all subplits as list
</span>
<span class="n">g0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>  <span class="c1"># line to start with
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vertex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vertices</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># save coordinates for bounding box
</span>    <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="s">"ko"</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># Draw vertex
</span>    <span class="c1"># Add polygons
</span>    <span class="k">for</span> <span class="n">gon</span> <span class="ow">in</span> <span class="n">vertex</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">coords</span><span class="p">(</span><span class="n">gon</span><span class="p">,</span> <span class="n">g0</span><span class="p">)</span>
        <span class="n">ps</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">make_patch</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">gon</span><span class="p">])</span>
        <span class="n">g0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># move starting line for next iteration
</span>    <span class="c1"># Bounding box
</span>    <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">1.05</span>
    <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">1.05</span>
    <span class="n">ax</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">vertex_str</span><span class="p">(</span><span class="n">vertex</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">));</span>

<span class="c1"># Ensure equal aspect and no axes for all plots
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">'equal'</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">'box'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

<span class="c1"># Save result
</span><span class="n">fig</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">"vertices.png"</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">'white'</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">"tight"</span><span class="p">)</span>


</code></pre></div>  </div>

</details>

<figure>
<p><img src="/assets/images/2022/04/17/vertices.png" alt="All possible vertices!" id="figure-1" width="80%" /></p>
  <figcaption>Figure 2: All possible vertices!</figcaption>
</figure>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2022/04/17/Vertices.html</link>
			<category>posts</category>
		    <category>geometry</category><category>maths</category><category>polygon</category><category>python</category><media:title type="html"><![CDATA[Polygon vertices ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2022/04/17/vertices.png" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2022/04/17/vertices.png" /><guid isPermaLink="true">https://thomasburgess.github.io/2022/04/17/Vertices.html</guid>
      <pubDate>Sun, 17 Apr 2022 00:00:00 +0200</pubDate>
		</item><item>
			<title>Tree hack</title>
			<description>
				<![CDATA[	
 				<h3><p>Building and printing a tree</p>
</h3>
    		<p>3 min.</p>
				<div><p><em>Header image credit</em><sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></p>

<p><em>In which I made two snippets for my trees.</em></p>

<h2 id="background">Background</h2>

<p>Recently, I had to write a python script that transforms incoming data organised in a 
folder structure. For this, I needed both a simple python representation and an easy way 
to print the data.</p>

<p>Consider a project which collects sightings of Bigfoot, Nessie,
and Yeti as <code class="highlighter-rouge">.csv</code> files for each day when there was a sighting.
As seen in <a href="#figure-1">Figure 1</a>, the data is organized into folders 
by cryptid and month.</p>

<figure>
<p><img src="/assets/images/2021/07/18/tree_hack_folder.png" alt="Folder strucutre" id="figure-1" width="50%" /></p>
  <figcaption>Figure 1: Folder structure</figcaption>
</figure>

<p>In my terminal, I’d show the structure with <a href="http://mama.indstate.edu/users/ice/tree/">tree</a> 
or <a href="https://github.com/Peltoche/lsd">lsd</a>. In python, I could use 
<a href="https://treelib.readthedocs.io/en/latest/">treelib</a>.
However, terminal tools don’t fit my actual needs, 
and for python, it feels excessive with a whole library for such a simple thing.
Time to reinvent the wheel…</p>

<h2 id="building-a-tree-from-a-directory">Building a tree from a directory</h2>

<p>I python version 3.4 or later, <a href="https://docs.python.org/3/library/pathlib.html">pathlib</a>
is included, which can get directory contents by 
<a href="https://en.wikipedia.org/wiki/Glob_(programming)">globbing</a>. For instance:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s">"data/"</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">"**/*.csv"</span><span class="p">))</span>
</code></pre></div></div>
<p>gives</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s">'data/nessie/2021-04/2021-04-03-sighting.csv'</span><span class="p">),</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s">'data/nessie/2021-02/2021-02-21-sighting.csv'</span><span class="p">),</span> <span class="p">...</span>
</code></pre></div></div>
<p>Note: this approach may fail for large directory trees, and not sure what happens if 
there are circular links in the tree. A simple way to get a tree representation without 
any classes is to use a dictionary <code class="highlighter-rouge">{"root": children}</code>. Here, <code class="highlighter-rouge">children</code> is another 
dictionary. For leaf nodes such as the <code class="highlighter-rouge">.csv</code> files, set the value to an empty 
dictionary.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">'data'</span><span class="p">:</span> <span class="p">{</span><span class="s">'nessie'</span><span class="p">:</span> <span class="p">{</span><span class="s">'2021-04'</span><span class="p">:</span> <span class="p">{</span><span class="s">'2021-04-03-sighting.csv'</span><span class="p">:</span> <span class="p">{},</span> <span class="p">...}</span> <span class="p">,</span> <span class="p">...},</span> <span class="p">...}}</span>
</code></pre></div></div>
<p>putting this together gives the following python snippet</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">path_tree</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"**/*"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="s">"""Build tree from path

    Example:
        path_tree(".", "**/*.csv")
        &gt;&gt;&gt; {'directory': {'file1.csv': {}, 'sub_directory': {'file2.csv': {}}}}

    Args:
        path (Path): Path to start search from
        pattern (str, optional): Pattern to glob all reports

    Returns:
        Dict[str, Any]: Dict of directories and report files
    """</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)).</span><span class="n">parts</span><span class="p">:</span>
            <span class="n">t</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># if q != p[-1] else True)
</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tree</span>
</code></pre></div></div>

<h2 id="pretty-printing-a-tree">Pretty printing a tree</h2>

<p>True its batteries-included philosophy, python comes with a 
<a href="https://docs.python.org/3/library/pprint.html">pretty-printer</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span><span class="s">'data'</span><span class="p">:</span> <span class="p">{</span><span class="s">'bigfoot'</span><span class="p">:</span> <span class="p">{</span><span class="s">'2021-01'</span><span class="p">:</span> <span class="p">{</span><span class="s">'2021-01-07-sighting.csv'</span><span class="p">:</span> <span class="p">{}},</span>
                      <span class="s">'2021-03'</span><span class="p">:</span> <span class="p">{</span><span class="s">'2021-03-04-sighting.csv'</span><span class="p">:</span> <span class="p">{},</span> 
                      <span class="p">....</span>
</code></pre></div></div>
<p>This often is good enough. However, I want something more tree-like so let’s add a basic
visualization using 
<a href="https://en.wikipedia.org/wiki/Box-drawing_character">box-drawing characters</a>. Here, I 
recursively loops through all dictionaries while remembering where to put <code class="highlighter-rouge">│</code>. As with 
glob, for large and highly nested trees (or cyclic content) this could perform poorly - 
but for most uses, it’s perfect.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="k">def</span> <span class="nf">tree_to_str</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""Make string from tree

    Example:
        tree_to_str({'directory': {'file1.csv': {}, 'sub_directory': {'file2.csv': {}}}})
        &gt;&gt;&gt; directory
            ├─ file1.csv
            └─ sub_directory
               └─ file2.csv

    Args:
        tree (Dict[Any, Any]): Dict with dicts
        b (List[bool], optional): stack to remember pipes

    Returns:
        str: String representation
    """</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">"  │"</span> <span class="k">if</span> <span class="n">q</span> <span class="k">else</span> <span class="s">"   "</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">b</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span>
                <span class="s">"  └"</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">"  ├"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"─ </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
        <span class="p">)</span>
        <span class="n">b</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">tree_to_str</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">b</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span>
</code></pre></div></div>

<h2 id="putting-it-all-together">Putting it all together</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">str_tree</span><span class="p">(</span><span class="n">path_tree</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="s">"**/*.csv"</span><span class="p">)))</span>
<span class="err">└─</span> <span class="n">data</span>
   <span class="err">├─</span> <span class="n">nessie</span>
   <span class="err">│</span>  <span class="err">├─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span>
   <span class="err">│</span>  <span class="err">│</span>  <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">│</span>  <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span>
   <span class="err">│</span>     <span class="err">├─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">│</span>     <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">├─</span> <span class="n">bigfoot</span>
   <span class="err">│</span>  <span class="err">├─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">01</span>
   <span class="err">│</span>  <span class="err">│</span>  <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">│</span>  <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span>
   <span class="err">│</span>     <span class="err">├─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">27</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">│</span>     <span class="err">├─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">│</span>     <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
   <span class="err">└─</span> <span class="n">yeti</span>
      <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span>
         <span class="err">├─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
         <span class="err">└─</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">14</span><span class="o">-</span><span class="n">sighting</span><span class="p">.</span><span class="n">csv</span>
</code></pre></div></div>

<p>Great! - just like the <code class="highlighter-rouge">tree</code> in the command line. And all with just in two simple 
functions. Like anything on this site, use these snippets as you please at your own 
risk, and feel free to credit me when you do it.</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>My crop of Photo by <a href="https://unsplash.com/@cristina_gottardi?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Cristina Gottardi</a> on <a href="https://unsplash.com/s/photos/mighty-tree?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2021/07/18/tree_hack.html</link>
			<category>posts</category>
		    <category>coding</category><category>python</category><category>trees</category><media:title type="html"><![CDATA[Tree hack ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2021/07/18/cristina-gottardi-wVTGdIGdojc-unsplash-crop.jpg" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2021/07/18/cristina-gottardi-wVTGdIGdojc-unsplash-crop.jpg" /><guid isPermaLink="true">https://thomasburgess.github.io/2021/07/18/tree_hack.html</guid>
      <pubDate>Sun, 18 Jul 2021 00:00:00 +0200</pubDate>
		</item><item>
			<title>Exploring repunit digit sum fractions</title>
			<description>
				<![CDATA[	
 				<h3><p>Down the integer sequences rabbit hole</p>
</h3>
    		<p>3 min.</p>
				<div><p><em>In which I go down a rabbit hole of integer sequences when trying to understand
a pattern in fractions of repeated digits and their digit sums.</em></p>

<h2 id="the-tweets">The tweets</h2>

<p><em>Note: this post was written when I was still using Twitter, I have since moved on to 
<a href="https://mathstodon.xyz/@ngons">mastodon</a>.</em></p>

<p>This tweet appeared in my Twitter feed:</p>

<figure>
<p><img src="/assets/images/2021/06/20/tweet.png" alt="Mathematics and mystery.555, 666, 777, and friends." id="figure-1" width="100%" /></p>
  <figcaption>Figure 1: Tweet 1 by Cliff Pickover 17 Jun 2021</figcaption>
</figure>

<p>These are the fraction of a <a href="https://en.wikipedia.org/wiki/Repdigit">repdigit</a> and the sum of its digits. My first thought was that I could write all these like this:
\[
  \frac{N}{N}\frac{111}{1+1+1}=37\,\quad\text{where } 0 \lt N \lt 10\,.
\]
Hence, these fractions are all <a href="https://en.wikipedia.org/wiki/Repunit">repunits</a>. 
A new question comes to mind: for which numbers of repeated digits n is the fraction an integer?</p>

<p>This handy formula from the Online Encylopedia of Integer Sequences (OEIS) <a href="https://oeis.org/A002275">A002275</a> generates repunits:
\[
  R_n=\frac{10^n - 1}{9}\,.
\]
As the sum in the denominator is just the number of digits, the fraction $Q$ then is
\[
  Q_n=\frac{R_n}{n} = \frac{10^n - 1}{9n}\,.
\]</p>

<p>I made a python script to see when the result is an integer:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">9</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
</code></pre></div></div>

<p>which gives integer fractions for \(Q=1\) for \(n=1\), \(Q=37\) for \(n=3\), and 
\(Q=12345679\) for \(n=9\).</p>

<details>
  <summary><i>Click to expand the full results of python script...</i><br />&nbsp;<br /></summary>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[(1, 1.0),
 (2, 5.5),
 (3, 37.0),
 (4, 277.75),
 (5, 2222.2),
 (6, 18518.5),
 (7, 158730.14285714287),
 (8, 1388888.875),
 (9, 12345679.0)]
</code></pre></div>  </div>

</details>

<p>I replied to the post with the case for \(n=9\), which led to this response:</p>

<figure>
<p><img src="/assets/images/2021/06/20/reply.png" alt="" id="figure-1" width="100%" /></p>
  <figcaption>Figure 2: Tweet 2 by Cliff Pickover 17 Jun 2021</figcaption>
</figure>

<p>On a tangent, a typo in my first reply pointed out by 
<a href="https://twitter.com/mikekohnstamm">@mikekohnstamm</a> added the “missing” \(8\) to 
\(Q=12345679\). Furthermore, <a href="https://twitter.com/Kapil_kant1">@Kapil_kant</a> pointed out 
that the \(8\) is there if the fraction is:
\[
  \frac{1111111101}{1+1+1+1+1+1+1+1+0+1}=123456789\,.
\]
I’ll save investigating that for another time.</p>

<h2 id="going-deeper">Going deeper</h2>

<p>A better way to search for exact integer fractions is to check when the modulus is 0 and 
only print those cases using integer division. This is done in the following python 
snippets:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Q"</span><span class="p">,</span> <span class="p">[(</span><span class="mi">10</span><span class="o">**</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">9</span> <span class="o">%</span> <span class="n">n</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"denominators"</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">9</span> <span class="o">%</span> <span class="n">n</span><span class="p">])</span>
</code></pre></div></div>

<p>This gives the solution sequence \(Q=1, 37, 12345679, 4115226337448559670781893,\ldots\) 
with denominators \(1, 3, 9, 27, 81, 111, 243, ...\). Evidently \(Q(n)\) grows very fast 
with \(111\) terms already at \(n=6\).</p>

<details>
  <summary><i>Click to expand the full results of python script...</i><br />&nbsp;<br /></summary>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Q: [1, 37, 12345679, 4115226337448559670781893, 
    1371742112482853223593964334705075445816186556927297668038408779149519890260631, 
    10010010010010010010010010010010010010010010010010010010010010010010010010010010...
    01001001001001001001001001001]
  denominators [1, 3, 9, 27, 81, 111, 243, 333, 729, 999, 2187, 2997, 4107, 6561, 
    8991, 12321, 13203, 19683]
</code></pre></div>  </div>

</details>

<p>Several series repunit-related sequences mention these numbers: <a href="https://oeis.org/A190301">A190301</a>,  <a href="https://oeis.org/A190301">A215258</a>, <a href="https://oeis.org/A190301">A215258</a>. I couldn’t find this sequence in the OEIS, so I registered and made it my first submission.</p>

<p>Update 2021-08-02: it is now sequence <a href="https://oeis.org/A345467">A215258</a> - Ratios R(k)/k for which R(k) / k is an integer, where R(k) = A002275(k) is a repunit.</p>

<p>The sequence of denominators 1, 3, 9, 27, 81, …, suggests the conjecture: \(Q\) is integer when \(n\) is of the form \(n=3^n\). One OEIS editor proved this elegantly for me: \(R_{3n} / R_n = 10^{2n} + 10^n + 1\), which is divisible by 3. Therefore, \(R_{3^m}\) is divisible by \(3^m\) by induction on \(m\). However, there are additional solutions: 111, 333, 999, …. There is no known general rule for the denominator. The full sequence of denominators is <a href="https://oeis.org/A014950">A014950</a> in OEIS. Using this with the OEIS sequence for \(R_n\) (<a href="https://oeis.org/A014950">A002275</a>), all the integer fractions are:
\[
  Q(n) = \frac{A002275(A014950(n))}{A014950(n)}\,.
\]</p>

<p>My favourite integer fraction so far is:
\[
  Q(6)=\frac{R_{111}}{111} = \ldots
\]
\[
\tiny
\frac{11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111}{111} = \ldots
\]
\[
\tiny
1001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001001
\]</p>

<h2 id="takeaway">Takeaway</h2>

<p>Twitter (in 2021), if done right, can be a source of inspiration and knowledge. Also,
 recreational maths is fun.</p>

<hr />

<p>Header image: repunit digit sum ratio remix of 
<a href="https://apod.nasa.gov/apod/ap210614.html">Ganymede from Juno</a>.</p>
</div>
				]]>
			</description>
			<link>https://thomasburgess.github.io/2021/06/20/repdigits.html</link>
			<category>posts</category>
		    <category>maths</category><category>oeis</category><media:title type="html"><![CDATA[Exploring repunit digit sum fractions ]]></media:title>
      <media:content url="https://thomasburgess.github.io/assets/images/2021/06/20/APOD_Ganymede_repunit.jpg" medium="image"/>
      <media:thumbnail url="https://thomasburgess.github.io/assets/images/2021/06/20/APOD_Ganymede_repunit.jpg" /><guid isPermaLink="true">https://thomasburgess.github.io/2021/06/20/repdigits.html</guid>
      <pubDate>Sun, 20 Jun 2021 00:00:00 +0200</pubDate>
		</item></channel>
</rss>